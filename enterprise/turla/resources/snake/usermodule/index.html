<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ST8G6EL3M2"></script>
    <script data-cfasync="false">window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'G-ST8G6EL3M2');</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="turbo-root" content="/ael">
    <meta name="turbo-cache-control" content="no-cache" data-turbo-track="reload" data-track-token="3.11.0.807110018169">

    <!-- See retype.com -->
    <meta name="generator" content="Retype 3.11.0">

    <!-- Primary Meta Tags -->
    <title>Snake User Module DLL</title>
    <meta name="title" content="Snake User Module DLL">
    <meta name="description" content="The Snake user module DLL is injected into various userland processes by the rookit via LoadLibrary.">

    <!-- Canonical -->
    <link rel="canonical" href="https://attackevals.github.io/ael/enterprise/turla/resources/snake/usermodule/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://attackevals.github.io/ael/enterprise/turla/resources/snake/usermodule/">
    <meta property="og:title" content="Snake User Module DLL">
    <meta property="og:description" content="The Snake user module DLL is injected into various userland processes by the rookit via LoadLibrary.">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://attackevals.github.io/ael/enterprise/turla/resources/snake/usermodule/">
    <meta property="twitter:title" content="Snake User Module DLL">
    <meta property="twitter:description" content="The Snake user module DLL is injected into various userland processes by the rookit via LoadLibrary.">

    <script data-cfasync="false">(function(){var cl=document.documentElement.classList,ls=localStorage.getItem("retype_scheme"),hd=cl.contains("dark"),hl=cl.contains("light"),wm=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;if(ls==="dark"||(!ls&&wm&&!hd&&!hl)){cl.remove("light");cl.add("dark")}else if(ls==="light"||(!ls&&!wm&&!hd&&!hl)){cl.remove("dark");cl.add("light")}})();</script>

    <link href="../../../../../favicon.png" rel="icon">
    <link href="../../../../../resources/css/retype.css?v=3.11.0.807110018169" rel="stylesheet">

    <script data-cfasync="false" src="../../../../../resources/js/config.js?v=3.11.0.807110018169" data-turbo-eval="false" defer></script>
    <script data-cfasync="false" src="../../../../../resources/js/retype.js?v=3.11.0" data-turbo-eval="false" defer></script>
    <script id="lunr-js" data-cfasync="false" src="../../../../../resources/js/lunr.js?v=3.11.0.807110018169" data-turbo-eval="false" defer></script>
</head>
<body>
    <div id="retype-app" class="relative text-base antialiased text-base-text bg-base-bg font-body">
        <div class="absolute bottom-0 left-0" style="top: 5rem; right: 50%"></div>
    
        <header id="retype-header" class="sticky top-0 z-30 flex w-full h-16 bg-header-bg border-b border-header-border md:h-20">
            <div class="container relative flex items-center justify-between pr-6 grow md:justify-start">
                <!-- Mobile menu button skeleton -->
                <button v-cloak class="skeleton retype-mobile-menu-button flex items-center justify-center shrink-0 overflow-hidden dark:text-white focus:outline-none rounded-full w-10 h-10 ml-3.5 md:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="mb-px shrink-0" width="24" height="24" viewBox="0 0 24 24" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor"><path d="M2 4h20v2H2zM2 11h20v2H2zM2 18h20v2H2z"></path></g></svg></button>
                <div v-cloak id="retype-sidebar-left-toggle-button"></div>
        
                <!-- Logo -->
                <div class="flex items-center justify-between h-full py-2 md:w-75">
                    <div class="flex items-center px-2 md:px-6">
                        <a id="retype-branding-logo" href="../../../../../" class="flex items-center leading-snug text-xl">
                            <span class="w-10 mr-2 grow-0 shrink-0 overflow-hidden">
                                <img class="max-h-10 dark:hidden md:inline-block" src="../../../../../images/attackevals-logo.png">
                                <img class="max-h-10 hidden dark:inline-block" src="../../../../../images/attackevals-logo.png">
                            </span>
                            <span class="dark:text-white font-bold line-clamp-1 md:line-clamp-2">ATTACK Evaluation Library</span>
                        </a>
                    </div>
        
                    <span class="hidden h-8 border-r md:inline-block border-base-border"></span>
                </div>
        
                <div class="flex justify-between md:grow">
                    <!-- Top Nav -->
                    <nav id="retype-header-nav" class="hidden md:flex">
                        <ul class="flex flex-col mb-4 md:pl-16 md:mb-0 md:flex-row md:items-center">
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://attackevals.mitre-engenuity.org">Attack Evaluations</a>
                            </li>
        
                        </ul>
                    </nav>
        
                    <!-- Header Right Skeleton -->
                    <div v-cloak class="flex justify-end grow skeleton">
        
                        <!-- Search input mock -->
                        <div class="relative hidden w-40 lg:block lg:max-w-sm lg:ml-auto">
                            <div class="absolute flex items-center justify-center h-full pl-3 dark:text-dark-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon-base" width="16" height="16" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 1px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                            </div>
                            <input class="w-full h-10 placeholder-search-placeholder transition-colors duration-200 ease-in bg-search-bg border border-transparent rounded md:text-sm hover:border-search-border-hover focus:outline-none focus:border-search-border-focus" style="padding: 0.625rem 0.75rem 0.625rem 2rem" type="text" placeholder="Search">
                        </div>
        
                        <!-- Mobile search button -->
                        <div class="flex items-center justify-center w-10 h-10 lg:hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="20" height="20" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                        </div>
        
                        <!-- Dark mode switch placeholder -->
                        <div class="w-10 h-10 lg:ml-2"></div>
        
                        <!-- History button -->
                        <div class="flex items-center justify-center w-10 h-10" style="margin-right: -0.625rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="22" height="22" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><g ><path d="M12.01 6.01c-.55 0-1 .45-1 1V12a1 1 0 00.4.8l3 2.22a.985.985 0 001.39-.2.996.996 0 00-.21-1.4l-2.6-1.92V7.01c.02-.55-.43-1-.98-1z"></path><path d="M12.01 1.91c-5.33 0-9.69 4.16-10.05 9.4l-.29-.26a.997.997 0 10-1.34 1.48l1.97 1.79c.19.17.43.26.67.26s.48-.09.67-.26l1.97-1.79a.997.997 0 10-1.34-1.48l-.31.28c.34-4.14 3.82-7.41 8.05-7.41 4.46 0 8.08 3.63 8.08 8.09s-3.63 8.08-8.08 8.08c-2.18 0-4.22-.85-5.75-2.4a.996.996 0 10-1.42 1.4 10.02 10.02 0 007.17 2.99c5.56 0 10.08-4.52 10.08-10.08.01-5.56-4.52-10.09-10.08-10.09z"></path></g></g></svg>
                        </div>
                    </div>
        
                    <div v-cloak class="flex justify-end grow">
                        <div id="retype-mobile-search-button"></div>
                        <doc-search-desktop></doc-search-desktop>
        
                        <doc-theme-switch class="lg:ml-2"></doc-theme-switch>
                        <doc-history></doc-history>
                    </div>
                </div>
            </div>
        </header>
    
    
        <div id="retype-container" class="container relative flex bg-white">
            <!-- Sidebar Skeleton -->
            <div v-cloak class="fixed flex flex-col shrink-0 duration-300 ease-in-out bg-sidebar-left-bg border-sidebar-left-border sidebar top-20 w-75 border-r h-screen md:sticky transition-transform skeleton">
            
                <div class="flex items-center h-16 px-6">
                    <input class="w-full h-8 px-3 py-2 transition-colors duration-200 ease-linear bg-filter-bg border border-filter-border rounded shadow-none text-sm focus:outline-none focus:border-filter-border-focus" type="text" placeholder="Filter">
                </div>
            
                <div class="pl-6 mt-1 mb-4">
                    <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                </div>
            
            </div>
            
            <!-- Sidebar component -->
            <doc-sidebar v-cloak>
                <template #sidebar-footer>
                    <div class="shrink-0 mt-auto border-t md:bg-transparent md:border-none dark:border-base-border">
            
                        <div class="py-3 px-6 md:hidden border-b dark:border-base-border">
                            <nav>
                                <ul class="flex flex-wrap justify-center items-center">
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://attackevals.mitre-engenuity.org">Attack Evaluations</a>
                                    </li>
            
                                </ul>
                            </nav>
                        </div>
                    </div>
                </template>
            </doc-sidebar>
    
            <div class="grow min-w-0 bg-body-bg">
                <!-- Render "toolbar" template here on api pages --><!-- Render page content -->
                <div class="flex">
                    <div id="retype-main" class="min-w-0 p-4 grow md:px-16">
                        <main class="relative pb-12 lg:pt-2">
                            <div class="retype-markdown" id="retype-content">
                                <!-- Rendered if sidebar right is enabled -->
                                <div id="retype-sidebar-right-toggle"></div>
                                <nav id="retype-breadcrumb" class="breadcrumb" aria-label="Breadcrumb">
                                    <ol role="list">
                                        <li class="pr-4">
                                            <a href="../../../../../" class="pr-4">
                                                ATT&​CK Evaluations Library
                                            </a>
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                                                <path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"/>
                                            </svg>
                                        </li>
                                        <li class="pr-4">
                                            <span class="pr-4">
                                                Enterprise
                                            </span>
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                                                <path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"/>
                                            </svg>
                                        </li>
                                        <li class="pr-4">
                                            <a href="../../../../../enterprise/turla/" class="pr-4">
                                                Turla
                                            </a>
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                                                <path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"/>
                                            </svg>
                                        </li>
                                        <li class="pr-4">
                                            <a href="../../../../../enterprise/turla/resources/" class="pr-4">
                                                Resources
                                            </a>
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                                                <path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"/>
                                            </svg>
                                        </li>
                                        <li class="pr-4">
                                            <a href="../../../../../enterprise/turla/resources/snake/" class="pr-4">
                                                Snake Rootkit
                                            </a>
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                                                <path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"/>
                                            </svg>
                                        </li>
                                        <li class="pr-4">
                                            <a href="../../../../../enterprise/turla/resources/snake/usermodule/" class="pr-4">
                                                Snake User Module DLL
                                            </a>
                                        </li>
                                    </ol>
                                </nav>
                
                                <!-- Page content  -->
<doc-anchor-target id="snake-user-module-dll" class="break-words">
    <h1>
        <doc-anchor-trigger class="header-anchor-trigger" to="#snake-user-module-dll">#</doc-anchor-trigger>
        <span>Snake User Module DLL</span>
    </h1>
</doc-anchor-target>
<div class="-mt-3 mb-12 flex flex-wrap text-sm text-gray-400 dark:text-dark-350 items-center print:justify-center">
    <div>In&nbsp;</div>
    <div><a href="../../categories/enterprise/">enterprise</a></div>
</div>

<doc-anchor-target id="overview">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#overview">#</doc-anchor-trigger>
        <span>Overview</span>
    </h2>
</doc-anchor-target>
<p>The Snake user module DLL is injected into various userland processes by the rookit via <code v-pre>LoadLibrary</code>. Once injected, the user module will either communicate with the C2 server or execute tasks, depending on its mode of operation. The mode of operation is determined by what process the module is injected into - if injected into a browser process, the module will run in C2 communication mode. Otherwise, it will run in task execution mode.</p>
<p>The DLL runs via its <code v-pre>DllMain</code> function and branches off into either C2 communication mode or task execution mode, depending on the name of the injected process. The following process names will trigger C2 communication mode:</p>
<ul>
<li>chrome.exe</li>
<li>firefox.exe</li>
<li>msedge.exe</li>
<li>iexplore.exe</li>
</ul>
<p>All other process names will trigger task execution mode.</p>
<p>For full functionality, the module must be injected into a browser process and non-browser process. This will allow communication with the C2 server as well as actual command execution. The two module modes communicate with each other via named pipes. Specifically, the C2 communication module listens on <code v-pre>\\.\pipe\commsecdev</code> for beacon requests and task output from the task execution module, and the task execution module listens on <code v-pre>\\.\pipe\commctrldev</code> for instructions passed on by the C2 communication module.</p>
<p>The task execution module will periodically send beacon requests to the C2 communications module, which will forward the requests to the C2 server and send back the instruction response. If the instruction is to download or upload files, the C2 communications module will handle that directly without intervention from the task execution module. If the instruction is to execute a process or command, the execution module will run the task and send the output to the C2 communications module to forward to the C2 server.</p>
<p>Turla has used a similar user module DLL architecture in the past where they broke functionality apart into a pipe server and pipe client module, where the pipe server would handle communications with the C2 server and the pipe client would handle other tasks like command execution<sup><a href="https://artemonsecurity.com/snake_whitepaper.pdf" class="outbound" target="_blank"><span>1</span><svg xmlns="http://www.w3.org/2000/svg" class="retype-outbound-trigger docs-icon ml-1" viewBox="0 0 24 24" role="presentation"><g fill="currentColor"><path d="M15.5 2.25a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0V4.06l-6.22 6.22a.75.75 0 1 1-1.06-1.06L19.94 3h-3.69a.75.75 0 0 1-.75-.75Z"/><path d="M2.5 4.25c0-.966.784-1.75 1.75-1.75h8.5a.75.75 0 0 1 0 1.5h-8.5a.25.25 0 0 0-.25.25v15.5c0 .138.112.25.25.25h15.5a.25.25 0 0 0 .25-.25v-8.5a.75.75 0 0 1 1.5 0v8.5a1.75 1.75 0 0 1-1.75 1.75H4.25a1.75 1.75 0 0 1-1.75-1.75V4.25Z"/></g></svg></a></sup>.</p>
<doc-anchor-target id="c2-communications">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#c2-communications">#</doc-anchor-trigger>
        <span>C2 Communications</span>
    </h2>
</doc-anchor-target>
<p>The user module communicates with a hardcoded C2 server and port value via HTTP GET/POST requests. To determine whether or not the server is online, the module will perform a heartbeat check by requesting the <code v-pre>/PUB/home.html</code> file. The server must respond with <code v-pre>1</code> to indicate that it is online.</p>
<p>Turla has used heartbeat URLs like <code v-pre>/D/pub.txt</code> and <code v-pre>/IMAGE/pub.html</code><sup><a href="https://artemonsecurity.com/snake_whitepaper.pdf" class="outbound" target="_blank"><span>1</span><svg xmlns="http://www.w3.org/2000/svg" class="retype-outbound-trigger docs-icon ml-1" viewBox="0 0 24 24" role="presentation"><g fill="currentColor"><path d="M15.5 2.25a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0V4.06l-6.22 6.22a.75.75 0 1 1-1.06-1.06L19.94 3h-3.69a.75.75 0 0 1-.75-.75Z"/><path d="M2.5 4.25c0-.966.784-1.75 1.75-1.75h8.5a.75.75 0 0 1 0 1.5h-8.5a.25.25 0 0 0-.25.25v15.5c0 .138.112.25.25.25h15.5a.25.25 0 0 0 .25-.25v-8.5a.75.75 0 0 1 1.5 0v8.5a1.75 1.75 0 0 1-1.75 1.75H4.25a1.75 1.75 0 0 1-1.75-1.75V4.25Z"/></g></svg></a></sup></p>
<p>After successful heartbeat verification, the module will perform <code v-pre>GET</code> requests on <code v-pre>/PUB/{implant_id}</code> (e.g. <code v-pre>GET /PUB/123456</code> to perform beacons and receive instructions. Some instructions may require the implant to run processes or execute shell commands, and the output will uploaded to the C2 server via <code v-pre>POST</code> requests to <code v-pre>/IMAGES/3/{instruction_id}</code> (e.g. <code v-pre>POST /IMAGES/3/123456789012345678</code> to upload the command output for instruction <code v-pre>123456789012345678</code>).</p>
<p>Note that while Turla has uploaded collected log files to its C2 server by sending <code v-pre>POST</code> requests to URLs like <code v-pre>/IMAGE/2/{random numbers}</code><sup><a href="https://artemonsecurity.com/snake_whitepaper.pdf" class="outbound" target="_blank"><span>1</span><svg xmlns="http://www.w3.org/2000/svg" class="retype-outbound-trigger docs-icon ml-1" viewBox="0 0 24 24" role="presentation"><g fill="currentColor"><path d="M15.5 2.25a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0V4.06l-6.22 6.22a.75.75 0 1 1-1.06-1.06L19.94 3h-3.69a.75.75 0 0 1-.75-.75Z"/><path d="M2.5 4.25c0-.966.784-1.75 1.75-1.75h8.5a.75.75 0 0 1 0 1.5h-8.5a.25.25 0 0 0-.25.25v15.5c0 .138.112.25.25.25h15.5a.25.25 0 0 0 .25-.25v-8.5a.75.75 0 0 1 1.5 0v8.5a1.75 1.75 0 0 1-1.75 1.75H4.25a1.75 1.75 0 0 1-1.75-1.75V4.25Z"/></g></svg></a></sup>, we opted to have the implant automatically send the output to the server to improve operator usability (i.e. not having to manually request command output each time a command is run).</p>
<p>When instructed to download a payload, the module will send a <code v-pre>GET</code> request to <code v-pre>/IMAGES/3/{instruction ID}</code>, using the instruction ID for the associated instruction. If the instruction ID matches a tasked instruction on the server side, the payload will be delivered, and the module will save it on disk at the specified location.</p>
<p>When instructed to upload an arbitrary file, the module will send a <code v-pre>POST</code> request to <code v-pre>/IMAGES/3/{instruction ID}</code>, using the instruction ID for the associated instruction. If the instruction ID matches a tasked instruction for non-command-output file uploads on the server side, the C2 server will accept the upload and save it server-side. Note that the endpoint is the same as for command output uploads - the C2 server distinguishes upload types based on the instruction ID used in the URL.</p>
<p>The implant can also be instructed to upload its log files via <code v-pre>POST</code> requests<sup><a href="https://artemonsecurity.com/snake_whitepaper.pdf" class="outbound" target="_blank"><span>1</span><svg xmlns="http://www.w3.org/2000/svg" class="retype-outbound-trigger docs-icon ml-1" viewBox="0 0 24 24" role="presentation"><g fill="currentColor"><path d="M15.5 2.25a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0V4.06l-6.22 6.22a.75.75 0 1 1-1.06-1.06L19.94 3h-3.69a.75.75 0 0 1-.75-.75Z"/><path d="M2.5 4.25c0-.966.784-1.75 1.75-1.75h8.5a.75.75 0 0 1 0 1.5h-8.5a.25.25 0 0 0-.25.25v15.5c0 .138.112.25.25.25h15.5a.25.25 0 0 0 .25-.25v-8.5a.75.75 0 0 1 1.5 0v8.5a1.75 1.75 0 0 1-1.75 1.75H4.25a1.75 1.75 0 0 1-1.75-1.75V4.25Z"/></g></svg></a></sup> to <code v-pre>/IMAGES/3/{log file ID}</code>, where the log file IDs are hardcoded ID strings for each log type:</p>
<ul>
<li><code v-pre>62810421015953103444</code> for C2 logs</li>
<li><code v-pre>23329841273669992682</code> for execution logs</li>
<li><code v-pre>59463656487865612747</code> for pipe server (C2 communications module) logs</li>
<li><code v-pre>16488587954892310865</code> for pipe client (task execution module) logs</li>
</ul>
<p>The implant will delete the log files after upload to clear them out<sup><a href="https://artemonsecurity.com/snake_whitepaper.pdf" class="outbound" target="_blank"><span>1</span><svg xmlns="http://www.w3.org/2000/svg" class="retype-outbound-trigger docs-icon ml-1" viewBox="0 0 24 24" role="presentation"><g fill="currentColor"><path d="M15.5 2.25a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0V4.06l-6.22 6.22a.75.75 0 1 1-1.06-1.06L19.94 3h-3.69a.75.75 0 0 1-.75-.75Z"/><path d="M2.5 4.25c0-.966.784-1.75 1.75-1.75h8.5a.75.75 0 0 1 0 1.5h-8.5a.25.25 0 0 0-.25.25v15.5c0 .138.112.25.25.25h15.5a.25.25 0 0 0 .25-.25v-8.5a.75.75 0 0 1 1.5 0v8.5a1.75 1.75 0 0 1-1.75 1.75H4.25a1.75 1.75 0 0 1-1.75-1.75V4.25Z"/></g></svg></a></sup>.</p>
<doc-anchor-target id="implant-id">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#implant-id">#</doc-anchor-trigger>
        <span>Implant ID</span>
    </h3>
</doc-anchor-target>
<p>Prior to beginning C2 communications, the comms module mode will look up the local victim&#x27;s computer name and use the first 10 characters as an XOR key against the default key value of <code v-pre>2157108421</code>. If the computer name is less than 10 characters, it is repeated as an XOR key. The XORed value is then converted to hex to represent the implant ID. If the implant fails to retrieve the computer name for whatever reason, it uses the default key value <code v-pre>2157108421</code> as the implant ID.</p>
<doc-anchor-target id="user-agent">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#user-agent">#</doc-anchor-trigger>
        <span>User Agent</span>
    </h3>
</doc-anchor-target>
<p>Turla has used the user agent string <code v-pre>Mozilla/4.0 (compatible; MSIE 6.0)</code> in the past for Snake<sup><a href="https://artemonsecurity.com/snake_whitepaper.pdf" class="outbound" target="_blank"><span>1</span><svg xmlns="http://www.w3.org/2000/svg" class="retype-outbound-trigger docs-icon ml-1" viewBox="0 0 24 24" role="presentation"><g fill="currentColor"><path d="M15.5 2.25a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0V4.06l-6.22 6.22a.75.75 0 1 1-1.06-1.06L19.94 3h-3.69a.75.75 0 0 1-.75-.75Z"/><path d="M2.5 4.25c0-.966.784-1.75 1.75-1.75h8.5a.75.75 0 0 1 0 1.5h-8.5a.25.25 0 0 0-.25.25v15.5c0 .138.112.25.25.25h15.5a.25.25 0 0 0 .25-.25v-8.5a.75.75 0 0 1 1.5 0v8.5a1.75 1.75 0 0 1-1.75 1.75H4.25a1.75 1.75 0 0 1-1.75-1.75V4.25Z"/></g></svg></a></sup>. However, to improve defense evasion purposes, we opted for setting a commonly used user agent based on the browser process that the user module is injected into:</p>
<ul>
<li>For <code v-pre>chrome.exe</code>, the user module will use <code v-pre>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</code></li>
<li>For <code v-pre>firefox.exe</code>, the user module will use <code v-pre>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:106.0) Gecko/20100101 Firefox/106.0</code></li>
<li>For <code v-pre>iexplore.exe</code>, the user module will use <code v-pre>Mozilla/5.0 (Windows NT 10.0; Trident/7.0; rv:11.0) like Gecko</code></li>
<li>For <code v-pre>msedge.exe</code>, the user module will use <code v-pre>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36 Edg/106.0.1370.52</code></li>
</ul>
<doc-anchor-target id="tasks">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#tasks">#</doc-anchor-trigger>
        <span>Tasks</span>
    </h2>
</doc-anchor-target>
<p>The implant receives tasking from the C2 server as part of a successful beacon response. If no task is specified, the implant receives a &quot;blank&quot; instruction that simply tells it to sleep for a random number of seconds, within a specified interval (currently between 10 and 20 seconds).</p>
<p>Each instruction, including empty instructions, is defined by an 18-digit random ID, and is categorized among various instruction types based on a 2-digit type code. The type code determines how to interpret the instruction arguments.</p>
<p>The following type codes are supported:</p>
<ul>
<li><code v-pre>00</code> - &quot;empty&quot; instruction. Don&#x27;t do anything other than sleep before the next beacon.</li>
<li><code v-pre>01</code> - shell command instruction to execute via <code v-pre>cmd.exe /c</code>. There will be a single instruction argument, which is a base64-encoded command that the implant will decode and execute. The command output will be sent to the C2 server afterwards.</li>
<li><code v-pre>02</code> - base64-encoded powershell instruction to execute via <code v-pre>powershell.exe -nol -noni -nop -enc ...</code>. There will be a single instruction argument, which is the base64-encoded command to run. The output will be sent to the C2 server afterwards. Note that we recommend prepending your powershell commands with <code v-pre>$ProgressPreference=&quot;SilentlyContinue&quot;;</code> to avoid the CLIXML stderr.</li>
<li><code v-pre>03</code> - instuction to spawn a process using the specified binary path and optional args. The optional args are base64-encoded, which the implant will decode and execute. The command output will be sent to the C2 server afterwards.</li>
<li><code v-pre>04</code> - instruction to download a file. There will be two arguments - the first one if the filename that is being requested from the C2 server (currently only used for logging purposes), and the second is the location to save the payload on disk. If only a filename is provided as the destination, the payload will be saved in the Snake home directory rather than the current directory (current directory is specified with an explicit <code v-pre>.\</code>).</li>
<li><code v-pre>05</code> - instruction to upload an arbitrary file. There will be one argument - the path to the file on the local system to upload to the C2 server.</li>
<li><code v-pre>06</code> - instruction to upload log files. No arguments needed, since the implant has the log file paths and IDs hardcoded.</li>
</ul>
<p>Instructions also come with various options:</p>
<ul>
<li>Sleep time, or how many seconds to sleep after performing the instruction and before sending the next beacon.</li>
<li>Username for a user to run a process as, if available.</li>
</ul>
<p>The overall received instruction blob uses the following format:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">ID[18-digit ID]#[2-digit type code] &amp;arg1&amp;arg2...&amp;argN[sleep time]&amp;[username to run command as]&amp;&amp;</code></pre>
</doc-codeblock></div>
<p>Example:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">ID402350900690432407#01 &amp;d2hvYW1pIC9hbGw=#20&amp;mydomain\myuser&amp;&amp;</code></pre>
</doc-codeblock></div>
<p>In the above example, the ID is <code v-pre>402350900690432407</code>, the type code is <code v-pre>01</code>, the command to execute is <code v-pre>whoami /all</code> as the user <code v-pre>mydomain\myuser</code>, and the implant will sleep for 20 seconds afterwards.</p>
<p>An empty instruction may look like this (type code <code v-pre>00</code>, sleep for 15 seconds):</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">ID760156340487338735#00 #15&amp;&amp;&amp;</code></pre>
</doc-codeblock></div>
<p>A payload instruction may look like the following:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">ID402350900690432407#04 &amp;malware.exe&amp;benign.exe#20&amp;&amp;&amp;</code></pre>
</doc-codeblock></div>
<p>In the above example, the module will request file <code v-pre>malware.exe</code> from the C2 server and save it as <code v-pre>benign.exe</code> in the Snake home directory.</p>
<p>Note that the available CTI does not dive into much detail in terms of the task format, especially for different instruction types. CTI shows a similar task format but for a different type of instruction (changing C2s rather than executing a shell command).<sup><a href="https://artemonsecurity.com/snake_whitepaper.pdf" class="outbound" target="_blank"><span>1</span><svg xmlns="http://www.w3.org/2000/svg" class="retype-outbound-trigger docs-icon ml-1" viewBox="0 0 24 24" role="presentation"><g fill="currentColor"><path d="M15.5 2.25a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0V4.06l-6.22 6.22a.75.75 0 1 1-1.06-1.06L19.94 3h-3.69a.75.75 0 0 1-.75-.75Z"/><path d="M2.5 4.25c0-.966.784-1.75 1.75-1.75h8.5a.75.75 0 0 1 0 1.5h-8.5a.25.25 0 0 0-.25.25v15.5c0 .138.112.25.25.25h15.5a.25.25 0 0 0 .25-.25v-8.5a.75.75 0 0 1 1.5 0v8.5a1.75 1.75 0 0 1-1.75 1.75H4.25a1.75 1.75 0 0 1-1.75-1.75V4.25Z"/></g></svg></a></sup></p>
<p>Task output is automatically sent to the C2 server for operator ease of use.</p>
<doc-anchor-target id="running-tasks-as-another-user">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#running-tasks-as-another-user">#</doc-anchor-trigger>
        <span>Running Tasks As Another User</span>
    </h3>
</doc-anchor-target>
<p>The user module has the capability to run tasks as another user. For instance, while the execution mode typically runs in a SYSTEM process, it can be instructed to start a process as a domain user or domain admin. The module will do this if the received instruction contains a username to run the
command as, in <code v-pre>domainname\username</code> format. The module will then do the following:</p>
<ul>
<li>Take a snapshot of all the current processes on the local system</li>
<li>Search through the processes until it finds a process belonging to the target user
<ul>
<li>If the process has an elevated token, the module will duplicate the process token and use it to spawn the child process</li>
<li>If the process belonging to the target user is not elevated, continue searching</li>
</ul>
</li>
<li>If all processes are searched and only a non-elevated process was found for the target user, the module will duplicate that token and use it to spawn the child process</li>
<li>If all processes are exhausted and no processes are found belonging to the target user, the module will run the command under its current context</li>
</ul>
<p>Some Turla samples have access token manipulation capabilities, such as indications of the <code v-pre>DuplicateTokenEx</code> and <code v-pre>OpenProcessToken</code> functions<sup><a href="https://www.circl.lu/pub/tr-25/" class="outbound" target="_blank"><span>3</span><svg xmlns="http://www.w3.org/2000/svg" class="retype-outbound-trigger docs-icon ml-1" viewBox="0 0 24 24" role="presentation"><g fill="currentColor"><path d="M15.5 2.25a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0V4.06l-6.22 6.22a.75.75 0 1 1-1.06-1.06L19.94 3h-3.69a.75.75 0 0 1-.75-.75Z"/><path d="M2.5 4.25c0-.966.784-1.75 1.75-1.75h8.5a.75.75 0 0 1 0 1.5h-8.5a.25.25 0 0 0-.25.25v15.5c0 .138.112.25.25.25h15.5a.25.25 0 0 0 .25-.25v-8.5a.75.75 0 0 1 1.5 0v8.5a1.75 1.75 0 0 1-1.75 1.75H4.25a1.75 1.75 0 0 1-1.75-1.75V4.25Z"/></g></svg></a></sup> .</p>
<doc-anchor-target id="encryption">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#encryption">#</doc-anchor-trigger>
        <span>Encryption</span>
    </h2>
</doc-anchor-target>
<doc-anchor-target id="c2">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#c2">#</doc-anchor-trigger>
        <span>C2</span>
    </h3>
</doc-anchor-target>
<p>Turla has used XOR-encryption for communication, such as for tasking and for log files.<sup><a href="https://artemonsecurity.com/snake_whitepaper.pdf" class="outbound" target="_blank"><span>1</span><svg xmlns="http://www.w3.org/2000/svg" class="retype-outbound-trigger docs-icon ml-1" viewBox="0 0 24 24" role="presentation"><g fill="currentColor"><path d="M15.5 2.25a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0V4.06l-6.22 6.22a.75.75 0 1 1-1.06-1.06L19.94 3h-3.69a.75.75 0 0 1-.75-.75Z"/><path d="M2.5 4.25c0-.966.784-1.75 1.75-1.75h8.5a.75.75 0 0 1 0 1.5h-8.5a.25.25 0 0 0-.25.25v15.5c0 .138.112.25.25.25h15.5a.25.25 0 0 0 .25-.25v-8.5a.75.75 0 0 1 1.5 0v8.5a1.75 1.75 0 0 1-1.75 1.75H4.25a1.75 1.75 0 0 1-1.75-1.75V4.25Z"/></g></svg></a></sup></p>
<p>We use a different XOR key from what Turla uses:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">1f903053jlfajsklj39019013ut098e77xhlajklqpozufoghi642098cbmdakandqiox536898jiqjpe6092smmkeut02906</code></pre>
</doc-codeblock></div>
<p>The user module uses XOR encryption in the following cases:</p>
<ul>
<li>decrypting beacon responses from the C2 server</li>
<li>encrypting command output when sending it to the C2 server</li>
<li>encrypting log messages</li>
<li>encrypting non-log file uploads to the C2 server (logs are already encrypted)</li>
<li>decrypting payload downloads from the C2 server</li>
</ul>
<doc-anchor-target id="named-pipes">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#named-pipes">#</doc-anchor-trigger>
        <span>Named Pipes</span>
    </h3>
</doc-anchor-target>
<p>Turla has used CAST-128 encryption for peer-to-peer named pipe communication in other implants.<sup><a href="https://www.welivesecurity.com/2017/03/30/carbon-paper-peering-turlas-second-stage-backdoor/" class="outbound" target="_blank"><span>2</span><svg xmlns="http://www.w3.org/2000/svg" class="retype-outbound-trigger docs-icon ml-1" viewBox="0 0 24 24" role="presentation"><g fill="currentColor"><path d="M15.5 2.25a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0V4.06l-6.22 6.22a.75.75 0 1 1-1.06-1.06L19.94 3h-3.69a.75.75 0 0 1-.75-.75Z"/><path d="M2.5 4.25c0-.966.784-1.75 1.75-1.75h8.5a.75.75 0 0 1 0 1.5h-8.5a.25.25 0 0 0-.25.25v15.5c0 .138.112.25.25.25h15.5a.25.25 0 0 0 .25-.25v-8.5a.75.75 0 0 1 1.5 0v8.5a1.75 1.75 0 0 1-1.75 1.75H4.25a1.75 1.75 0 0 1-1.75-1.75V4.25Z"/></g></svg></a></sup></p>
<p>To keep a similar approach, the emulated implant uses CAST-128 encryption for named pipe communication between the execution and comms module modes.</p>
<p>The 128-bit key used is <code v-pre>c7daecf7df559a1a6eb1da73617d82c1</code>, which is derived from 5 iterations of PBKDF2-SHA1, with a passphrase of <code v-pre>checkmateNASA</code> and salt value of <code v-pre>saltandpepper</code>. The passphrase and salt value are hardcoded in the implant, and the key is derived when the implant starts.</p>
<doc-anchor-target id="logging">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#logging">#</doc-anchor-trigger>
        <span>Logging</span>
    </h2>
</doc-anchor-target>
<p>The user module will log various debug, info, and error messages throughout its execution. Various log files are used to split up the different logging categories:</p>
<ul>
<li><code v-pre>svcmon32.sdb</code> for C2-related logging (heartbeats, beacons, payload downloads, instruction parsing, data uploads)</li>
<li><code v-pre>svcstat64.bin</code> for pipe server logging (when in pipe server mode)</li>
<li><code v-pre>udmon32.bin</code> for pipe client logging (when in pipe client / execution mode)</li>
<li><code v-pre>dbsvcng64.bin</code> for logging related to command execution (process creation, exit codes, command output)</li>
</ul>
<p>The log files are located in the Snake home directory. Each log message is XOR-encrypted and base-64 encoded prior to being appended to the corresponding log file as a new line. The plaintext format is as follows:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">[LOG LEVEL] [YYYY-MM-DD HH:MM:SS] message</code></pre>
</doc-codeblock></div>
<p>Example:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">[DEBUG] [2022-10-06 15:38:32] Received cmd output for instruction 250559001934813785:</code></pre>
</doc-codeblock></div>
<p>Note that timestamps are in UTC.</p>
<doc-anchor-target id="file-mutexes">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#file-mutexes">#</doc-anchor-trigger>
        <span>File Mutexes</span>
    </h2>
</doc-anchor-target>
<p>Since the communication and execution modes both touch the execution and pipe client log files, the Snake user module creates a global mutex for each file:</p>
<ul>
<li><code v-pre>Global\WindowsCommCtrlDB</code> for the pipe client log</li>
<li><code v-pre>Global\WinBaseSvcDBLock</code> for the execution log</li>
</ul>
<p>The different usermodule modes will use the mutexes to coordinate synchronized file access for the commonly used log files.</p>
<p>Turla has used mutexes in the past, for instance in their Carbon DLL implant.<sup><a href="https://www.welivesecurity.com/2017/03/30/carbon-paper-peering-turlas-second-stage-backdoor/" class="outbound" target="_blank"><span>2</span><svg xmlns="http://www.w3.org/2000/svg" class="retype-outbound-trigger docs-icon ml-1" viewBox="0 0 24 24" role="presentation"><g fill="currentColor"><path d="M15.5 2.25a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0V4.06l-6.22 6.22a.75.75 0 1 1-1.06-1.06L19.94 3h-3.69a.75.75 0 0 1-.75-.75Z"/><path d="M2.5 4.25c0-.966.784-1.75 1.75-1.75h8.5a.75.75 0 0 1 0 1.5h-8.5a.25.25 0 0 0-.25.25v15.5c0 .138.112.25.25.25h15.5a.25.25 0 0 0 .25-.25v-8.5a.75.75 0 0 1 1.5 0v8.5a1.75 1.75 0 0 1-1.75 1.75H4.25a1.75 1.75 0 0 1-1.75-1.75V4.25Z"/></g></svg></a></sup></p>
<doc-anchor-target id="troubleshooting">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#troubleshooting">#</doc-anchor-trigger>
        <span>Troubleshooting</span>
    </h2>
</doc-anchor-target>
<p>If the Snake installer is successful but you don&#x27;t receive a beacon, there are two main possible points of failure:</p>
<ol>
<li>The driver was unable to inject successfully into <code v-pre>taskhostw.exe</code> or the injected DLL crashed</li>
<li>The driver was unable to inject successfully into <code v-pre>msedge.exe</code>, or the injected DLL crashed</li>
</ol>
<p>You can generally tell which injected DLLs started up by looking for the log files and checking their timestamps:</p>
<ul>
<li>The C2-related log (<code v-pre>svcmon32.sdb</code>) is used exclusively by the browser-injected DLL process. If the file exists, then the injected DLL was at least able to get far enough to begin logging. If the file exists but is not being updated, then either the DLL crashed or is stuck waiting for the taskhostw-injected DLL to connect to it via named pipes.</li>
<li>The execution log (<code v-pre>dbsvcng64.bin</code>) is used exclusively by the taskhostw-injected DLL and has at least one line written to it when the injected DLL starts up. If the file exists, then the injected DLL was at least able to get far enough to begin logging.</li>
</ul>
<p>There are two ways to decrypt and read the log files:</p>
<ul>
<li>If you have successful beacons and are troubleshooting other issues, you can task the implant to upload the logs to the C2 server, which will automatically decrypt them and write them to the <code v-pre>control_server/files</code> directory:
<ul>
<li><code v-pre>./evalsC2client.py --set-task &lt;guid&gt; '{&quot;type&quot;: 6}'</code></li>
</ul>
</li>
<li>If you do not have a beacon, you will have to manually copy the files from the Windows target host to your linux C2 server, where you can call the
<code v-pre>control_server/handlers/snake/decrypt_logs.py</code> utility like so:
<ul>
<li><code v-pre>python3 decrypt_logs.py -p /path/to/log -o /path/to/output/file</code></li>
</ul>
</li>
</ul>
<p>Each log file covers different aspects of the implant:</p>
<ul>
<li><code v-pre>svcmon32.sdb</code> for C2-related logging (heartbeats, beacons, payload downloads, instruction parsing, data uploads)</li>
<li><code v-pre>svcstat64.bin</code> for pipe server logging (when in pipe server mode)</li>
<li><code v-pre>udmon32.bin</code> for pipe client logging (when in pipe client / execution mode)</li>
<li><code v-pre>dbsvcng64.bin</code> for logging related to command execution (process creation, exit codes, command output)</li>
</ul>
<p>To investigate general C2 communication issues, look at the C2 logs and pipe-related logging.</p>
<p>To investigate execution-related issues (e.g. failed token impersonation), look at the execution log.</p>
<p>Note that error codes in the logs will either be a <a href="https://learn.microsoft.com/en-us/windows/win32/debug/system-error-codes--0-499-" class="outbound" target="_blank"><span>Windows system error code</span><svg xmlns="http://www.w3.org/2000/svg" class="retype-outbound-trigger docs-icon ml-1" viewBox="0 0 24 24" role="presentation"><g fill="currentColor"><path d="M15.5 2.25a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0V4.06l-6.22 6.22a.75.75 0 1 1-1.06-1.06L19.94 3h-3.69a.75.75 0 0 1-.75-.75Z"/><path d="M2.5 4.25c0-.966.784-1.75 1.75-1.75h8.5a.75.75 0 0 1 0 1.5h-8.5a.25.25 0 0 0-.25.25v15.5c0 .138.112.25.25.25h15.5a.25.25 0 0 0 .25-.25v-8.5a.75.75 0 0 1 1.5 0v8.5a1.75 1.75 0 0 1-1.75 1.75H4.25a1.75 1.75 0 0 1-1.75-1.75V4.25Z"/></g></svg></a> or a custom error code defined in <code v-pre>include/usermodule_errors.h</code></p>
<doc-anchor-target id="build-instructions">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#build-instructions">#</doc-anchor-trigger>
        <span>Build Instructions</span>
    </h2>
</doc-anchor-target>
<p>The module requires the <a href="https://github.com/weidai11/cryptopp" class="outbound" target="_blank"><span>Crypto++ library</span><svg xmlns="http://www.w3.org/2000/svg" class="retype-outbound-trigger docs-icon ml-1" viewBox="0 0 24 24" role="presentation"><g fill="currentColor"><path d="M15.5 2.25a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0V4.06l-6.22 6.22a.75.75 0 1 1-1.06-1.06L19.94 3h-3.69a.75.75 0 0 1-.75-.75Z"/><path d="M2.5 4.25c0-.966.784-1.75 1.75-1.75h8.5a.75.75 0 0 1 0 1.5h-8.5a.25.25 0 0 0-.25.25v15.5c0 .138.112.25.25.25h15.5a.25.25 0 0 0 .25-.25v-8.5a.75.75 0 0 1 1.5 0v8.5a1.75 1.75 0 0 1-1.75 1.75H4.25a1.75 1.75 0 0 1-1.75-1.75V4.25Z"/></g></svg></a> to be built and linked at compile-time.
The library was installed on 64-bit Windows using <code v-pre>msys2</code> and <code v-pre>mingw64</code> using the following steps</p>
<ul>
<li><code v-pre>choco install msys2</code></li>
<li>Add <code v-pre>C:\tools\msys64</code> to your PATH enviromment variable to run <code v-pre>msys2</code>. Reopen console windows to register the new env variable.</li>
<li>Run <code v-pre>msys2</code> and within the new prompt, run the following:</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">pacman -Syu
pacman -S --needed base-devel mingw-w64-x86_64-toolchain
pacman -S mingw-w64-x86_64-crypto++</code></pre>
</doc-codeblock></div>
<p>Either through the UI or through Powershell, set the user environment variable for <code v-pre>MINGW64_ROOT</code> so that the value is the directory
where mingw64 was installed via msys2 above:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">[System.Environment]::SetEnvironmentVariable('MINGW64_ROOT','C:\path\to\mingw64', 'User')</code></pre>
</doc-codeblock></div>
<p>For example: <code v-pre>[System.Environment]::SetEnvironmentVariable('MINGW64_ROOT','C:\tools\msys64\mingw64', 'User')</code></p>
<p>Reopen any command prompts or terminal windows.</p>
<p>Build the usermodule DLL using the following build command in Powershell from the <code v-pre>Resources\Snake\UserModule</code> directory.
If you want to adjust certain preprocessor directives for the C2 address, C2 port, and home directory, you can do so in the compilation command:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">x86_64-w64-mingw32-g++ -DC2_ADDRESS=&quot;10.0.2.11&quot; -DC2_PORT=8080 -DHOME_DIR=&quot;C:\\Users\\Public\\testing&quot; -I include -I &quot;$env:MINGW64_ROOT\include\cryptopp&quot; -static -shared -std=c++20 -Wall -Wextra -Werror -o bin\usermodule.dll src\*.cpp -lWinInet -L &quot;$env:MINGW64_ROOT\lib&quot; -l cryptopp;</code></pre>
</doc-codeblock></div>
<p>To remove symbols, you can use the <code v-pre>strip</code> command:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">strip -s bin/usermodule.dll</code></pre>
</doc-codeblock></div>
<p>To verify, you can run <code v-pre>strings</code> or <code v-pre>objdump --syms bin/usermodule.dll</code> - you should see an empty symbols table.</p>
<doc-anchor-target id="unit-tests">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#unit-tests">#</doc-anchor-trigger>
        <span>Unit Tests</span>
    </h2>
</doc-anchor-target>
<p>Unit tests were run on a Windows machine using CMake. Each component subfolder has its own unit test setup.</p>
<ol>
<li>Make sure CMake is installed on your machine
<ul>
<li><code v-pre>choco install cmake --installargs '&quot;ADD_CMAKE_TO_PATH=System&quot;'</code></li>
<li>You will need to restart the shell to use cmake.</li>
<li>If cmake was already installed but is not in your path, add it to your path manually (e.g. <code v-pre>C:\Program Files\CMake\bin</code>)</li>
</ul>
</li>
<li>Make sure mingw64 is installed on your machine. In this particular example, <code v-pre>msys2</code> was installed and used to install mingw64.
<ul>
<li><code v-pre>choco install msys2</code></li>
<li>Add <code v-pre>C:\tools\msys64</code> to your PATH enviromment variable to run <code v-pre>msys2</code>. Reopen console windows to register the new env variable.</li>
<li>Run <code v-pre>msys2</code> and within the new prompt, run the following:
<ul>
<li><code v-pre>pacman -Syu</code></li>
<li><code v-pre>pacman -S --needed base-devel mingw-w64-x86_64-toolchain</code></li>
</ul>
</li>
</ul>
</li>
<li>Ensure the following paths are set in the SYSTEM environment PATH variable (note that these may differ in your environment depending on how you installed CMake and mingw64).
<ul>
<li><code v-pre>C:\Program Files\CMake\bin</code> or equivalent CMake <code v-pre>bin</code> folder</li>
<li><code v-pre>C:\tools\msys64\mingw64\bin</code> or equivalent Mingw-w64 <code v-pre>bin</code> folder</li>
<li>Paths  to folders containing <code v-pre>gcc</code> and <code v-pre>g++</code> compilers if not already included in the above Mingw-w64 path folder.</li>
<li>Reopen console windows to register the new env variables.</li>
</ul>
</li>
<li>Set up and run tests via Powershell from the <code v-pre>UserModule</code> directory:</li>
</ol>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">cmake -DCMAKE_EXPORT_COMPILE_COMMANDS:BOOL=TRUE -DCMAKE_BUILD_TYPE:STRING=Release -DCMAKE_C_COMPILER:FILEPATH=gcc.exe -DCMAKE_CXX_COMPILER:FILEPATH=g++.exe -S . -B build -G &quot;MinGW Makefiles&quot;
cmake --build build --config Release --target all -j 4 --
cd build
ctest --output-on-failure</code></pre>
</doc-codeblock></div>
<p>(OPTIONAL) If running CMake via Visual Studio Code:</p>
<ol>
<li>Make sure you have the following VS Code extensions:
<ul>
<li>CMake</li>
<li>CMake Tools</li>
<li>C/C++</li>
</ul>
</li>
<li>Configure CMake settings in VS Code:
<ul>
<li>CMake: CMake Path
<ul>
<li>Set to wherever the cmake executable is located</li>
</ul>
</li>
<li>CMake: Generator
<ul>
<li>Set to &quot;MinGW Makefiles&quot; (no quotes)</li>
</ul>
</li>
</ul>
</li>
<li>Open the <code v-pre>UserModule</code> project folder in VS Code</li>
<li>In Command Palette, run <code v-pre>CMake: Run Tests</code></li>
</ol>
<doc-anchor-target id="cti-references">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#cti-references">#</doc-anchor-trigger>
        <span>CTI References</span>
    </h2>
</doc-anchor-target>
<ol>
<li><a href="https://artemonsecurity.com/snake_whitepaper.pdf">https://artemonsecurity.com/snake_whitepaper.pdf</a></li>
<li><a href="https://www.welivesecurity.com/2017/03/30/carbon-paper-peering-turlas-second-stage-backdoor/">https://www.welivesecurity.com/2017/03/30/carbon-paper-peering-turlas-second-stage-backdoor/</a></li>
<li><a href="https://www.circl.lu/pub/tr-25/">https://www.circl.lu/pub/tr-25/</a></li>
</ol>

                                
                                <!-- Required only on API pages -->
                                <doc-toolbar-member-filter-no-results></doc-toolbar-member-filter-no-results>
                            </div>
                            <footer id="retype-content-footer" class="clear-both">
                            
                                <nav id="retype-nextprev" class="print:hidden flex mt-14">
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 h-full flex items-center break-normal font-medium text-body-link border border-base-border hover:border-base-border-hover rounded-l-lg transition-colors duration-150 relative hover:z-5" href="../../../../../enterprise/turla/resources/snake/snakeinstaller/">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mr-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19 11H7.41l5.29-5.29a.996.996 0 10-1.41-1.41l-7 7a1 1 0 000 1.42l7 7a1.024 1.024 0 001.42-.01.996.996 0 000-1.41L7.41 13H19c.55 0 1-.45 1-1s-.45-1-1-1z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                            <span>
                                                <span class="block text-xs font-normal text-base-text-muted">Previous</span>
                                                <span class="block mt-1">Snake Installer</span>
                                            </span>
                                        </a>
                                    </div>
                            
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 -mx-px h-full flex items-center justify-end break-normal font-medium text-body-link border border-base-border hover:border-base-border-hover rounded-r-lg transition-colors duration-150 relative hover:z-5" href="../../../../../enterprise/turla/resources/setup/">
                                            <span>
                                                <span class="block text-xs font-normal text-right text-base-text-muted">Next</span>
                                                <span class="block mt-1">Turla Setup Procedure</span>
                                            </span>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19.92 12.38a1 1 0 00-.22-1.09l-7-7a.996.996 0 10-1.41 1.41l5.3 5.3H5c-.55 0-1 .45-1 1s.45 1 1 1h11.59l-5.29 5.29a.996.996 0 000 1.41c.19.2.44.3.7.3s.51-.1.71-.29l7-7c.09-.09.16-.21.21-.33z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                        </a>
                                    </div>
                                </nav>
                            </footer>
                        </main>
                
                        <div id="retype-page-footer" class="print:border-none border-t border-base-border pt-6 mb-8">
                            <footer class="flex flex-wrap items-center justify-between print:justify-center">
                                <div id="retype-footer-links" class="print:hidden">
                                    <ul class="flex flex-wrap items-center text-sm">
                                        <li>
                                            <a class="inline-flex items-center mr-4 py-2 text-sm whitespace-nowrap transition-colors duration-200 ease-linear text-footer-link hover:text-footer-link-hover md:mb-0" href="https://github.com/attackevals/ael">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                                    <g fill="currentColor">
                                                        <path d="M12 1C5.923 1 1 5.923 1 12c0 4.867 3.149 8.979 7.521 10.436.55.096.756-.233.756-.522 0-.262-.013-1.128-.013-2.049-2.764.509-3.479-.674-3.699-1.292-.124-.317-.66-1.293-1.127-1.554-.385-.207-.936-.715-.014-.729.866-.014 1.485.797 1.691 1.128.99 1.663 2.571 1.196 3.204.907.096-.715.385-1.196.701-1.471-2.448-.275-5.005-1.224-5.005-5.432 0-1.196.426-2.186 1.128-2.956-.111-.275-.496-1.402.11-2.915 0 0 .921-.288 3.024 1.128a10.193 10.193 0 0 1 2.75-.371c.936 0 1.871.123 2.75.371 2.104-1.43 3.025-1.128 3.025-1.128.605 1.513.221 2.64.111 2.915.701.77 1.127 1.747 1.127 2.956 0 4.222-2.571 5.157-5.019 5.432.399.344.743 1.004.743 2.035 0 1.471-.014 2.654-.014 3.025 0 .289.206.632.756.522C19.851 20.979 23 16.854 23 12c0-6.077-4.922-11-11-11Z"/>
                                                    </g>
                                                </svg>
                                                <span>ATTACK Evaluations Library GitHub</span>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                                <div id="retype-copyright" class="print:justify-center py-2 text-footer-text font-footer-link-weight text-sm leading-relaxed"><p>© Copyright 2025. All rights reserved.</p></div>
                            </footer>
                        </div>
                    </div>
                
                    <!-- Rendered if sidebar right is enabled -->
                    <!-- Sidebar right skeleton-->
                    <div v-cloak class="fixed top-0 bottom-0 right-0 translate-x-full bg-sidebar-right-bg border-sidebar-right-border lg:sticky lg:border-l lg:shrink-0 lg:pt-6 lg:transform-none sm:w-1/2 lg:w-64 lg:z-0 md:w-104 sidebar-right skeleton">
                        <div class="pl-5">
                            <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                            <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                            <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                        </div>
                    </div>
                
                    <!-- User should be able to hide sidebar right -->
                    <doc-sidebar-right v-cloak></doc-sidebar-right>
                </div>

            </div>
        </div>
    
        <doc-search-mobile></doc-search-mobile>
        <doc-back-to-top></doc-back-to-top>
    </div>


    <div id="retype-overlay-target"></div>

    <script data-cfasync="false">window.__DOCS__ = { "title": "Snake User Module DLL", level: 5, icon: "file", hasPrism: false, hasMermaid: false, hasMath: false, tocDepth: 23 }</script>
</body>
</html>
