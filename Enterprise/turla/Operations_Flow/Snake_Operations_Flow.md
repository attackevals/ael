# Snake Emulation Scenario ðŸ“–

Based on open-source intelligence, the ATT&CK Â® Evaluations team created the below scenario leveraging techniques seen from Turla in the wild. We have adapted the scenario based on tools and resources available at the time. Below is a [scenario overview](#overview), [step-by-step breakdown](#scenario-steps), and an [infrastructure diagram](#infrastructure-diagram).

## Overview

This scenario is a continuation of Turlaâ€™s multi-phase operation, as part of an ongoing intelligence collection campaign. The attackers establish a typo-squatting website to target entities with a high value of information. Turla targets the victim with a drive-by compromise, through user interaction Adobe Flash installer bundled with EPIC, is installed on the victimâ€™s Windows workstation. EPIC communicates to the C2 server via proxy web server with HTTPS requests, persists via process injection, and performs enumeration on the victimâ€™s workstation. SNAKE is then deployed to maintain foothold, elevate privileges and communicates to the C2 via HTTP/SMTP/DNS.

Next, the attackers move laterally onto a Microsoft IIS server, install SNAKE, and create an admin account. They then proceed to move laterally onto an Exchange workstation, and install SNAKE. Finally, the attackers move laterally onto an Exchange Server and install LIGHTNERON. LIGHTNERON enables email collection, and staging for exfiltrating stolen data via benign email PDF/JPG attachments. In this, the threat actors are able to collect and exfiltrate sensitive communications in an effort to identify new information sources and collect up-to-date information to further their the mission objectives.

<br>**Phase 1:** _EglÄ—_, an IIS Admin visits a legitimate but compromised website. The website contains a JavaScript that fingerprints users with an MD5 hash. Now identified as a target, the next time EglÄ— visits the website, the JavaScript initiates a drive-by compromise via malicious adobe flash installer. Through _EglÄ—'s_ interaction, the malicious Adobe Flash installer bundled with EPIC, is installed on the victim Windows workstation. EPIC begins to communicate with the C2 server via proxy web server with HTTPS requests.

<br>**Phase 2:** EPIC persists via process injection, conducting defense evasion, specifically searching for commonly named processes associated with network defense applications and executing guardrails to not persist on previously infected devices. The attackers then use EPIC to perform enumeration on _EglÄ—'s_ workstation. The results are saved in a zip file for exfiltration, then deleted after exfiltration. Next, SNAKE is deployed as second-stage malware on _EglÄ—'s_ workstation to maintain a foothold and elevate privileges while communicating with C2 via HTTP/SMTP/DNS. With Kernel access via SNAKE, the attackers collect user log-in information from _EglÄ—'s_ workstation, enabling the collection and compromise of valid accounts.

<br>**Phase 3:** An account found on _EglÄ—'s_ workstation is used to laterally move onto the Microsoft IIS server. SNAKE is installed on the IIS server and the attackers create their own admin account, gaining unrestricted access on the network. Next, the attackers laterally move to _Å½ilvinas'_ Exchange Workstation and install SNAKE. A new user account _Leshy_ is created under the domain admin group. The attackers then laterally move onto the Exchange Server and install LightNeuron. Rule modification from LIGHTNERON enables collection and staging for exfiltration. LIGHTNEURON exfiltrates stolen data via benign email PDF/JPG attachments to attacker-controlled email addresses.
<br><br>

![Snake Operations Flow Diagram](../Resources/Images/SnakeOpsFlow.png)

![Snake Software Flow Diagram](../Resources/Images/SnakeSoftwareDiagram.png)

## Scenario StepsðŸ‘£

 |<div style="width:500px">Steps & Techniques</div>| <div style="width:290px">User Story</div> | <div style="width:290px">Commands</div>| <div style="width:290px">Software</div> | <div style="width:290px">Reporting</div> |
 | :------------- | :------------- | :-------------: |------------- | ------------- |
 |**Step 11 Initial Compromise & Establish Foothold** <br> [T1189](https://attack.mitre.org/versions/v12/techniques/T1189): Drive-by Compromise <br> [T1204.001](https://attack.mitre.org/versions/v12/techniques/T1204/001): User Execution <br> [T1071.001](https://attack.mitre.org/versions/v12/techniques/T1071/001/): Application Layer Protocol: Web Protocols <br> [T1090.002](https://attack.mitre.org/versions/v12/techniques/T1090/002/): Proxy: External Proxy <br> [T1071.001](https://attack.mitre.org/versions/v12/techniques/T1071/001/): Application Layer Protocol: Web Protocols <br> [T1082](https://attack.mitre.org/versions/v12/techniques/T1082): System Information Discovery| User _Egle_ on WIN10 workstation (`10.100.40.103`) Azuolas visits a legitimate, but compromised website `nato-int.com`. This website was tampered to redirect visitors to a typo-squated malicious website that contains javascript (JS). The malicious website `anto-int.com`. fingerprints Egle. This malicious WordPress website prompts Egle with a notice to update their NotFlash. <br><br> _Egle_ clicks to download the update, `NTFVersion_e5.exe`, containing EPIC (a.k.a. Tavdig/Wipbot). Epic will inject its guard DLL into `explorer.exe`. it will then search for processes that are typically internet enabled (e.g. `iexplore.exe`, `msedge.exe`, or `firefox.exe`) and inject an embedded worker DLL. Once C2 communications have been established between EPIC and the C2 via the proxy server, discovery is performed on the first host where information about the host device and domain computers is collected. | |<br> Clicky Jscript <br> Evercookie EPIC | <br><https://recon.cx/2018/brussels/resources/slides/RECON-BRX-2018-Visiting-The-Snake-Nest.pdf> <br><https://www.welivesecurity.com/2020/03/12/tracking-turla-new-backdoor-armenian-watering-holes/> <br><https://www.welivesecurity.com/2017/06/06/turlas-watering-hole-campaign-updated-firefox-extension-abusing-instagram/> <br><https://github.com/samyk/evercookie> <br><https://www.govcert.ch/downloads/whitepapers/Report_Ruag-Espionage-Case.pdf> <br><https://securelist.com/analysis/publications/65545/the-epic-turla-operation/> <br><https://www.symantec.com/content/en/us/enterprise/media/security_response/whitepapers/waterbug-attack-group.pdf> <br><https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2018/03/08080105/KL_Epic_Turla_Technical_Appendix_20140806.pdf> |
 **Step 12 Rootkit Installation** <br> [T1105](https://attack.mitre.org/versions/v12/techniques/T1105): Ingress Tool Transfer <br>[T1014]( https://attack.mitre.org/versions/v12/techniques/T1014): Rootkit<br> [T1027]( https://attack.mitre.org/versions/v12/techniques/T1027): Obfuscated Files or Information<br> [T1070]( https://attack.mitre.org/versions/v12/techniques/T1070): Indicator Removal<br> [T1140]( https://attack.mitre.org/versions/v12/techniques/T1140): Deobfuscate/Decode Files or Information<br> [T1546]( https://attack.mitre.org/versions/v12/techniques/T1546): Event Triggered Execution<br> [T1543.003](https://attack.mitre.org/versions/v12/techniques/T1543/003/): Create or Modify System Process: Windows Service<br> [T1553.006](https://attack.mitre.org/versions/v12/techniques/T1553/006/): Subvert Trust Controls: Code Signing Policy Modification<br>[T1055.001](https://attack.mitre.org/versions/v12/techniques/T1055/001/): Process Injection: Dynamic-link Library Injection<br> [T1573.001]( https://attack.mitre.org/versions/v12/techniques/T1573/001/): Encrypted Channel: Symmetric Cryptography<br> [T1071.001]( https://attack.mitre.org/versions/v12/techniques/T1071/001/): Application Layer Protocol: Web Protocols<br> [T1070.004]( https://attack.mitre.org/versions/v12/techniques/T1070/004/): Indicator Removal: File Deletion|Using access from EPIC by Egle on WIN10 workstation Azuolas, SNAKE is pulled down to Azuolas as second-stage malware. The Snake installer will escalate privileges to SYSTEM by exploiting a Windows 10 vulnerability. Once running as SYSTEM, the installer will disable DSE by loading and exploiting a vulnerable driver. Once DSE is disabled, the installer will load the Snake rootkit driver. <br><br>The rootkit driver will hook various functions and will inject a user-mode DLL into a SYSTEM process to execute received tasks from the C2 server. The driver will then wait for a browser process to make a network request to inject the user-mode DLL into the browser for C2 communications over HTTP. The injected DLLs will communicate between each other via named pipes. At some point, Egle will browse to a website, triggering the rootkit driver to inject the user-mode DLL into the browser process - this DLL will begin communication with the C2 server over HTTP. | |SNAKE | <br><https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2014/08/20082358/uroburos.pdf> <br><https://artemonsecurity.com/snake_whitepaper.pdf> <br><https://public.gdatasoftware.com/Web/Content/INT/Blog/2014/02_2014/documents/GData_Uroburos_RedPaper_EN_v1.pdf> <https://www.circl.lu/pub/tr-25> <br><https://www.gdatasoftware.com/blog/2014/03/23966-uroburos-deeper-travel-into-kernel-protection-mitigation> <br><https://www.gdatasoftware.com/blog/2014/06/23953-analysis-of-uroburos-using-windbg> <br><https://www.gdatasoftware.com/blog/2015/01/23926-analysis-of-project-cobra> <br><https://blog.tetrane.com/2019/Analysis-Uroburos-Malware-REVEN.html> <https://blog.talosintelligence.com/2014/04/snake-campaign-few-words-about-uroburos.html> <br><https://www.lastline.com/labsblog/dissecting-turla-rootkit-malware-using-dynamic-analysis/> <https://www.lastline.com/labsblog/turla-apt-group-gives-their-kernel-exploit-a-makeover/> <br><https://github.com/hfiref0x/TDL> <br><https://www.coresecurity.com/core-labs/advisories/virtualbox-privilege-escalation-vulnerability> <https://unit42.paloaltonetworks.com/acidbox-rare-malware/> |
**Step 13 First Workstation Discovery**<br>[T1106]( https://attack.mitre.org/versions/v12/techniques/T1106/): Native API<br>[T1057]( https://attack.mitre.org/versions/v12/techniques/T1057): Process Discovery<br> [T1559]( https://attack.mitre.org/versions/v12/techniques/T1559): Inter-Process Communication<br>[T1087.002]( https://attack.mitre.org/versions/v12/techniques/T1087/002/): Account Discovery: Domain Account<br>[T1049]( https://attack.mitre.org/versions/v12/techniques/T1049): System Network Connections Discovery<br> [T1134.002]( https://attack.mitre.org/versions/v12/techniques/T1134/002/): Access Token Manipulation: Create Process with Token<br>[T1134.001]( https://attack.mitre.org/versions/v12/techniques/T1134/001/): Access Token Manipulation: Token Impersonation/Theft |The Snake rootkit receives tasking from the C2 server to enumerate currently running processes on the local computer and finds that EgleAdmin has processes running. <br><br>Further enumeration of the EgleAdmin user shows that it is a member of the File Server Admins group. Snake then enumerates mapped drives on the local machine and finds that Egle's home drive is mapped to the file server, berzas (`10.100.30.204`). |`whoami` <br>`tasklist.exe` <br>`net.exe user /domain EgleAdmin` | SNAKE | <https://artemonsecurity.com/snake_whitepaper.pdf> |
**Step 14 Lateral Movement to File Server** <br>[T1078.002]( https://attack.mitre.org/versions/v12/techniques/T1078/002/): Valid Accounts: Domain Account<br>[T1559]( https://attack.mitre.org/versions/v12/techniques/T1559): Inter-Process Communication<br> [T1105]( https://attack.mitre.org/versions/v12/techniques/T1105): Ingress Tool Transfer<br>[T1569.002]( https://attack.mitre.org/versions/v12/techniques/T1569/002/): System Services: Service Execution<br> [T1071.001]( https://attack.mitre.org/versions/v12/techniques/T1071/001/): Application Layer Protocol: Web Protocols<br> [T1070.004]( https://attack.mitre.org/versions/v12/techniques/T1070/004/): Indicator Removal: File Deletion |Using this information, Snake impersonates the EgleAdmin account to run PsExec and execute another copy of the Snake rootkit installer on the file server, berzas. <br><br> This new copy of the Snake installer will have the installed rootkit beacon back to the C2 server via a different redirector. | |SNAKE PSExec | <https://artemonsecurity.com/snake_whitepaper.pdf> |
**Step 15 Domain Discovery**  <br>[T1018]( https://attack.mitre.org/versions/v12/techniques/T1018): Remote System Discovery<br>[T1059.001]( https://attack.mitre.org/versions/v12/techniques/T1059/001): Command and Scripting Interpreter: PowerShell<br> [T1069.001]( https://attack.mitre.org/versions/v12/techniques/T1069/001): Permission Group Discovery: Domain Groups<br> [T1087.002]( https://attack.mitre.org/versions/v12/techniques/T1087/002): Account Discovery: Domain Account<br> |The Snake rootkit receives tasking from the C2 server to use Powershell's ActiveDirectory module to enumerate domain users, admin groups, and computers. Upon discovering Zilvinas's regular and domain admin accounts, Snake will enumerate further details on the accounts. Snake then discovers a workstation, uosis (`10.100.40.102`), belonging to Zilvinas to use as a future lateral movement target. |  |SNAKE <br> Powershell | <br><https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2014/08/20082358/uroburos.pdf> <br><https://artemonsecurity.com/snake_whitepaper.pdf> <br> <https://public.gdatasoftware.com/Web/Content/INT/Blog/2014/02_2014/documents/GData_Uroburos_RedPaper_EN_v1.pdf> <br> <https://www.circl.lu/pub/tr-25/> <br><https://www.gdatasoftware.com/blog/2014/03/23966-uroburos-deeper-travel-into-kernel-protection-mitigation> <br><https://www.gdatasoftware.com/blog/2014/06/23953-analysis-of-uroburos-using-windbg> <br><https://www.gdatasoftware.com/blog/2015/01/23926-analysis-of-project-cobra> <br><https://blog.tetrane.com/2019/Analysis-Uroburos-Malware-REVEN.html> <br><https://blog.talosintelligence.com/2014/04/snake-campaign-few-words-about-uroburos.html> <br><https://www.lastline.com/labsblog/dissecting-turla-rootkit-malware-using-dynamic-analysis/> <br><https://www.lastline.com/labsblog/turla-apt-group-gives-their-kernel-exploit-a-makeover/> <br><https://github.com/hfiref0x/TDL> <br><https://www.coresecurity.com/core-labs/advisories/virtualbox-privilege-escalation-vulnerability> <br><https://unit42.paloaltonetworks.com/acidbox-rare-malware/> |
**Step 16 Preparation for Lateral Movement to Admin Workstation** <br>[T1105]( https://attack.mitre.org/versions/v12/techniques/T1105): Ingress Tool Transfer<br>[T1559]( https://attack.mitre.org/versions/v12/techniques/T1559): Inter-Process Communication <br>[T1003.001]( https://attack.mitre.org/versions/v12/techniques/T1003/001): OS Credential Dumping: LSASS Memory|Snake downloads Mimikatz to the file server, berzas (`10.100.30.204`), and extracts all NTLM hashes on the target to a file. That file is then exfiltrated back to the C2 server.||PSExec <br> Mimikatz | <https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/waterbug-espionage-governments> <br> <https://www.govcert.ch/downloads/whitepapers/Report_Ruag-Espionage-Case.pdf> |
**Step 17 Lateral Movement to Admin Workstation & Persistence**<br>[T1057]( https://attack.mitre.org/versions/v12/techniques/T1057): Process Discovery<br>[T1136.002]( https://attack.mitre.org/versions/v12/techniques/T1136/002): Create Account: Domain Account<br>[T1550.002]( https://attack.mitre.org/versions/v12/techniques/T1550/002): Use Alternate Authentication Material: Pass the Hash<br>[T1071.001]( https://attack.mitre.org/versions/v12/techniques/T1071/001): Application Layer Protocol: Web Protocols<br>[T1070.004]( https://attack.mitre.org/versions/v12/techniques/T1070/004): Indicator Removal: File Deletion |Snake performs lateral movement to the domain admin's workstation and enables additional persistence by creating a new domain admin account. <br> <br>The retrieved NTLM hash discovered in the previous step is used in a pass-the-hash attack to move laterally to Zilvinas's workstation. PsExec is employed via pass-the-hash to execute and install the Snake rootkit on the target workstation. <br><br> Once the admin workstation has been compromised, Snake is used to enumerate processes running on Zilvinas's workstation uosis, where it is discovered that ZilvinasAdmin has processes running which can be used for token impersonation. By impersonating ZilvinasAdmin, a new domain user Leshy is created and added to the Domain Admins domain group for persistence. |`whoami`<br> `tasklist.exe`<br> `net user leshy Password12345 /add /domain` <br>`net group \"Domain Admins\" leshy /add /domain` |SNAKE | <https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2014/08/20082358/uroburos.pdf> <br><https://artemonsecurity.com/snake_whitepaper.pdf> <br><https://public.gdatasoftware.com/Web/Content/INT/Blog/2014/02_2014/documents/GData_Uroburos_RedPaper_EN_v1.pdf> <br><https://www.circl.lu/pub/tr-25/> <br><https://www.gdatasoftware.com/blog/2014/03/23966-uroburos-deeper-travel-into-kernel-protection-mitigation> <br><https://www.gdatasoftware.com/blog/2014/06/23953-analysis-of-uroburos-using-windbg> <br><https://www.gdatasoftware.com/blog/2015/01/23926-analysis-of-project-cobra> <br><https://blog.tetrane.com/2019/Analysis-Uroburos-Malware-REVEN.html> <br><https://blog.talosintelligence.com/2014/04/snake-campaign-few-words-about-uroburos.html> <br><https://www.lastline.com/labsblog/dissecting-turla-rootkit-malware-using-dynamic-analysis/> <br><https://www.lastline.com/labsblog/turla-apt-group-gives-their-kernel-exploit-a-makeover/> <br><https://github.com/hfiref0x/TDL> <br><https://www.coresecurity.com/core-labs/advisories/virtualbox-privilege-escalation-vulnerability> <br><https://unit42.paloaltonetworks.com/acidbox-rare-malware/> |
**Step 18 Lateral Movement to Exchange Server** <br> [T1559]( https://attack.mitre.org/versions/v12/techniques/T1559): Inter-Process Communication<br> [T1105]( https://attack.mitre.org/versions/v12/techniques/T1105): Ingress Tool Transfer<br> [T1070.004]( https://attack.mitre.org/versions/v12/techniques/T1070/004): Indicator Removal: File Deletion <br> [T1047]( https://attack.mitre.org/versions/v12/techniques/T1047): Windows Management Instrumentation<br> [T1059.001]( https://attack.mitre.org/versions/v12/techniques/T1059/001): Command and Scripting Interpreter: PowerShell<br> [T1505.002]( https://attack.mitre.org/versions/v12/techniques/T1505/002): Server Software Component: Transport Agent<br>[T1036.005]( https://attack.mitre.org/versions/v12/techniques/T1036/005): Masquerading: Match Legitimate Name or Location<br> |Snake downloads LightNeuron and associated the Powershell installation script and config files, transfers them to the Exchange server, drebule, and remotely executes the installation script using WMI to install LightNeuron on the Exchange server. | |WMI <br> SNAKE <br> LIGHT NEURON <br> Powershell | <https://www.govcert.ch/downloads/whitepapers/Report_Ruag-Espionage-Case.pdf> |
**Step 19 Discovery & Email Collection** <br>[T1119]( https://attack.mitre.org/versions/v12/techniques/T1119): Automated Collection<br>[T1114.002]( https://attack.mitre.org/versions/v12/techniques/T1114/002): Email Collection: Remote Email Collection<br>[T1001.002]( https://attack.mitre.org/versions/v12/techniques/T1001/002): Data Obfuscation: Steganography<br>[T1071.003]( https://attack.mitre.org/versions/v12/techniques/T1071/003): Application Layer Protocol: Mail Protocols<br>[T1016]( https://attack.mitre.org/versions/v12/techniques/T1016): System Network Configuration Discovery<br>[T1564.008]( https://attack.mitre.org/versions/v12/techniques/T1564/008): Email Hiding Rules<br>[T1573.001]( https://attack.mitre.org/versions/v12/techniques/T1573/001): Encrypted Channel: Symmetric Cryptography<br>[T1041]( https://attack.mitre.org/versions/v12/techniques/T1041): Exfiltration Over C2 Channel<br>[T1059.003]( https://attack.mitre.org/versions/v12/techniques/T1059/003): Command and Scripting Interpreter: Windows Command Shell | Turla sends several discovery commands to the LightNeuron implant and collecting and exfiltrating email traffic. <br><br> Emails with JPG attachments containing AES encrypted commands embedded using stegonagraphy are sent from the C2 server to the domain. LightNeuron's transport agent processes all emails via LightNeuron's companion DLL, which executes the embedded command and blocks delivery of the email from the C2 server. <br><br> LightNeuron automatically collects all emails with recipients matching `nk.local` in a log file(`C:\Windows\ServiceProfiles\NetworkService\AppData\Local\Temp\msmdat.xml`).Eventually, LightNeuron is tasked to exfiltrate the email log, which is exfiltrated over the existing C2 channel. | |LIGHT NEURON | <https://www.welivesecurity.com/wp-content/uploads/2019/05/ESET-LightNeuron.pdf> |

## Infrastructure Diagram

![Snake Infrastructure Diagram](../Resources/Images/SnakeInfrastructure.png)
